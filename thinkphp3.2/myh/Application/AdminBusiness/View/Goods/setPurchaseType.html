<extend name="Public:base" />
<block name="css-customize">
    <link type="text/css" rel="stylesheet" href="PUBLIC_ADMIN_CSS/common/fenlei.css" />
    <link type="text/css" rel="stylesheet" href="PUBLIC_ADMIN_CSS/common/skin.css" />
</block>
<block name="content">
    <div class="page">
        <div class="fixed-bar">
            <div class="item-title">
                <ul class="tab-base">
                    <li><a href="{:U('Goods/goodsManage')}" ><span>管理</span></a></li>
                    <li><a href="{:U('Goods/goodsBaseEdit')}" ><span>新增</span></a></li>
                    <li><a href="javascript:void(0);" class="current" ><span>设置产品购买类型</span></a></li></li>
                </ul>
            </div>
        </div>
        <div style="margin-top:15px;">
            <form id="form1">
                <div class="buy_fields">
                    <span class="product_name">{$goodsBaseInfo.name}</span>产品的购买类型
                </div>
                <div class="buy_fields">
                    零售价格：<span class="opt_type retail_price">{$goodsBaseInfo.price}</span>
                </div>
                <input class="buy_fields goods_base_id" type="hidden" value="{$goodsBaseInfo.id}">
                <table id=table18 class="add_new_merchandise" border=0 cellspacing=1 width="100%" height=57>
                    <tbody>
                    <tr class="radioProductType">
                        <td class="dotted_bottom_gray product_type_field set_product_type" height=40 width="11%" >
                            <span class="buy_typeSet_title">商品购买类型设置：</span>
                        </td>
                    </tr>
                    <tr class="radioProductType">
                        <td class="dotted_bottom_gray city_part_module set_product_type" width="89%" align=left>
                            <empty name="goodsList" id="vv">
                                <volist name="Think.config.BUY_TYPE" id="vo">
                                    <div class="set_type_list">
                                        <input type="checkbox" name="discount"  class="radioItem" value="{$vo.name}" data-buy_type="{$vo.buy_type}" ><label for="">{$vo.name}</label>
                                        <span class="opt_type"><font color="#FF0000">*</font>{$vo.price_name}：</span>
                                        <input style="width: 120px; " class="inputboxadmin discount_price" name="discount_price" value="">

                                        <notempty name="vo.referrer_commission">
                                            <span class="opt_type"><font color="#FF0000">*</font>{$vo.referrer_commission}：</span>
                                            <input style="width: 120px; " class="inputboxadmin referrer_commission" name="referrer_commission" value="">
                                        </notempty>
                                        <notempty name="vo.agency_commission">
                                            <span class="opt_type"><font color="#FF0000">*</font>{$vo.agency_commission}：</span>
                                            <input style="width: 120px; " class="inputboxadmin agency_commission" name="agency_commission" value="">
                                        </notempty>
                                        <notempty name="vo.partner_commission">
                                            <span class="opt_type"><font color="#FF0000">*</font>{$vo.partner_commission}：</span>
                                            <input style="width: 120px; " class="inputboxadmin partner_commission" name="partner_commission" value="">
                                        </notempty>
                                        <notempty name="vo.cash_back">
                                            <span class="opt_type"><font color="#FF0000">*</font>{$vo.cash_back}：</span>
                                            <input style="width: 120px; " class="inputboxadmin cash_back" name="cash_back" value="">
                                        </notempty>
                                    </div>
                                </volist>
                                <else />
                                <!--设置的类型-->
                                <volist name="goodsList" id="vv">
                                    <volist name="Think.config.BUY_TYPE" id="vo">
                                        <if condition="$vv.buy_type eq ($vo['buy_type'])">
                                            <div class="set_type_list">
                                                <input type="hidden" name="goods_id" value="{$vv.id}"/>
                                                <input type="checkbox" name="discount"  class="radioItem" value="{$vo.name}" data-buy_type="{$vo.buy_type}" checked="checked"><label for="">{$vo.name}</label>
                                                <span class="opt_type"><font color="#FF0000">*</font>{$vo.price_name}：</span>
                                                <input style="width: 120px; " class="inputboxadmin discount_price" name="discount_price" value="{$vv.sale_price}">

                                                <notempty name="vo.referrer_commission">
                                                    <span class="opt_type"><font color="#FF0000">*</font>{$vo.referrer_commission}：</span>
                                                    <input style="width: 120px; " class="inputboxadmin referrer_commission" name="referrer_commission" value="{$vv.referrer_commission}">
                                                </notempty>
                                                <notempty name="vo.agency_commission">
                                                    <span class="opt_type"><font color="#FF0000">*</font>{$vo.agency_commission}：</span>
                                                    <input style="width: 120px; " class="inputboxadmin agency_commission" name="agency_commission" value="{$vv.agency_commission}">
                                                </notempty>
                                                <notempty name="vo.partner_commission">
                                                    <span class="opt_type"><font color="#FF0000">*</font>{$vo.partner_commission}：</span>
                                                    <input style="width: 120px; " class="inputboxadmin partner_commission" name="partner_commission" value="{$vv.partner_commission}">
                                                </notempty>
                                                <notempty name="vo.cash_back">
                                                    <span class="opt_type"><font color="#FF0000">*</font>{$vo.cash_back}：</span>
                                                    <input style="width: 120px; " class="inputboxadmin cash_back" name="cash_back" value="{$vv.cash_back}">
                                                </notempty>
                                            </div>
                                        </if>
                                    </volist>
                                </volist>
                                <!--没有设置的类型-->
                                <volist name="noBuyTypeArray" id="vv">
                                    <volist name="Think.config.BUY_TYPE" id="vo">
                                        <if condition="$vv eq ($vo['buy_type'])">
                                            <div class="set_type_list">
                                                <input type="checkbox" name="discount"  class="radioItem" value="{$vo.name}" data-buy_type="{$vo.buy_type}"><label for="">{$vo.name}</label>
                                                <span class="opt_type"><font color="#FF0000">*</font>{$vo.price_name}：</span>
                                                <input style="width: 120px; " class="inputboxadmin discount_price" name="discount_price" value="">

                                                <notempty name="vo.referrer_commission">
                                                    <span class="opt_type"><font color="#FF0000">*</font>{$vo.referrer_commission}：</span>
                                                    <input style="width: 120px; " class="inputboxadmin referrer_commission" name="referrer_commission" value="">
                                                </notempty>
                                                <notempty name="vo.agency_commission">
                                                    <span class="opt_type"><font color="#FF0000">*</font>{$vo.agency_commission}：</span>
                                                    <input style="width: 120px; " class="inputboxadmin agency_commission" name="agency_commission" value="">
                                                </notempty>
                                                <notempty name="vo.partner_commission">
                                                    <span class="opt_type"><font color="#FF0000">*</font>{$vo.partner_commission}：</span>
                                                    <input style="width: 120px; " class="inputboxadmin partner_commission" name="partner_commission" value="">
                                                </notempty>
                                                <notempty name="vo.cash_back">
                                                    <span class="opt_type"><font color="#FF0000">*</font>{$vo.cash_back}：</span>
                                                    <input style="width: 120px; " class="inputboxadmin cash_back" name="cash_back" value="">
                                                </notempty>
                                            </div>
                                        </if>
                                    </volist>
                                </volist>
                            </empty>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </form>
            <tr>
                <td width="11%"></td>
                <td height=60 width="50%" align=center>
                    <div class="upload_finish_btn">
                        <input class="button_save_black_4" value="确定" type="button">
                        &nbsp;&nbsp;
                        <input class="button_save_black" name="add0" value="返回" type="button">
                    </div>
                </td>
            </tr>
        </div>
    </div>
</block>
<block name="script">
    <script type="text/javascript">
        $(function(){
            $('.discount_price').on('keyup',function(){
                var _this=$(this);
                var promotionPrice=parseFloat($(this).val());
                var retailPrice=$('.retail_price').text();
                if(!isMoney(promotionPrice)){
                    if($('.error_tipc_txt').length>0){
                        return false;
                    }
                    _this.after('<span class="error_tipc_txt">请输入正确的金额</span>');
                    $(this).val('');
                    _this.focus();
                    return false;
                }else {
                    $('.error_tipc_txt').remove();
                    if(promotionPrice>retailPrice){
                        _this.after('<span class="error_tipc_txt">输入的价格不能大于零售价</span>');
                        return false;
                    }else{
                        $('.error_tipc_txt').remove();
                    }
                }
            });
            $('.discount_price').on('blur',function(){
                $('.error_tipc_txt').remove();
            });
            //确定
            $('.button_save_black_4').on('click',function(){
                var editData=[];
                var editArr={};
                var addData=[];
                var addArr={};
                var delData=[];
                var goodsBaseId=$('.goods_base_id').val();
                $.each($('.set_type_list'),function(i,val){
                    var _this=$(this);
                    var optionCheck=_this.find('.radioItem');
                    var goods_Id=_this.find('input[name="goods_id"]').val();
                    var promotionPrice=_this.find('.discount_price').val();
                    var referrer_commission =_this.find('input[name="referrer_commission"]').val();
                    var agency_commission =_this.find('input[name="agency_commission"]').val();
                    var partner_commission =_this.find('input[name="partner_commission"]').val();
                    var cashBack =_this.find('input[name="cash_back"]').val();
                    if(optionCheck.is(":checked")){
                        var buyType=optionCheck.data('buy_type');
                        if(goods_Id){
                            editArr={
                                goods_base_id:goodsBaseId,
                                buy_type:buyType,
                                sale_price:promotionPrice,
                                goods_id:goods_Id,
                                referrer_commission:referrer_commission,
                                agency_commission:agency_commission,
                                partner_commission:partner_commission,
                                cash_back:cashBack
                            };
                            editData.push(editArr);
                        }else{
                            addArr={
                                goods_base_id:goodsBaseId,
                                buy_type:buyType,
                                sale_price:promotionPrice,
                                goods_id:goods_Id,
                                referrer_commission:referrer_commission,
                                agency_commission:agency_commission,
                                partner_commission:partner_commission,
                                cash_back:cashBack
                            };
                            addData.push(addArr);
                        }
                    }else{
                        delData.push(goods_Id);
                    }
                });
                $.post(CONTROLLER + '/setPurchaseType',{addData:addData,editData:editData,delData:delData},function(msg){
                    if(!msg.status){

                    }else{
                        var url = CONTROLLER + '/goodsManage';
                        dialog.success('',url);
                    }
                },'JSON');
            });

            //返回
            $('.button_save_black').click(function(){
                location.href = CONTROLLER + '/goodsManage';
            });
        });
    </script>
</block>