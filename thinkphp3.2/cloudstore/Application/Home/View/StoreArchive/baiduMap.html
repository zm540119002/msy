<extend name="Public:base" />
<block name="css-customize">
    <link rel="stylesheet" type="text/css" href="{$Think.config.PUBLIC_CSS}/home/storeSettings.css">
</block>
<block name="content">
    <div class="ditumap">
        <a href="javascript:void(0);" class="mapBtn f24">确定</a>
        <div class="ditumap_part" id="r-result">
            <input type="text" id="suggestId" class="ditu_search_text f24" placeholder="输入地点搜索" />
        </div>
        <div id="searchResultPanel" style="border:1px solid #C0C0C0;width:150px;height:auto; display:none;"></div>
        <div style="border:none;" id="l-map"></div>
    </div>
</block>
<block name="mjs-customize">
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=Fimtwu6FDRrHWvg3oq44YCw0c0YonNpv"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.js"></script>
    <script type="text/javascript">
        //定位后的地址
        var selectAddr = '{$addr}';
        var shopId = '{$shopId}';
        $(function(){
            var deviceHeight = $(document).height();
            var body = document.getElementsByTagName('body')[0];
            $('#l-map').css({height:deviceHeight+'px'});
            body.addEventListener('touchstart',function(e){
                $('#suggestId').blur();
            });
            body.addEventListener('touchmove',function(e){
                $('#suggestId').blur();
            });
            body.addEventListener('touchend',function(e){
                $('#suggestId').blur();
            });

            //初始化
            setPlace(selectAddr);

            //确定
            $('.mapBtn').click(function(){
                var postData = {};
                postData.address = selectAddr;
                postData.shopId = shopId;

                $.post(ACTION,postData,function (msg) {
                    layer.open({
                        content:msg.info,
                        time:2
                    });
                    return false;
                });
            });
        });

        // 百度地图API功能
        function G(id) {
            return document.getElementById(id);
        }

        // 初始化地图,设置城市和地图级别。
        var map = new BMap.Map("l-map");
        map.centerAndZoom("广州",12);

        //手动标识
        function showInfo(e){
            map.clearOverlays();
            var new_point=new BMap.Point(e.point.lng,e.point.lat);
            var marker=new BMap.Marker(new_point);
            marker.enableDragging(); //marker可拖拽
            map.addOverlay(marker);
            map.panTo(new_point);
            var gc = new BMap.Geocoder();
            gc.getLocation(new_point, function(rs){
                var addComp = rs.addressComponents;
                var mapAddress=addComp.province + "" + addComp.city + "" + addComp.district + "" + addComp.street + "" + addComp.streetNumber;
                selectAddr = mapAddress;
            });
        }
        map.addEventListener("click", showInfo);

        //建立一个自动完成的对象
        var ac = new BMap.Autocomplete(
            {
                "input" : "suggestId",
                "location" : map
            }
        );
        
        //当前所在城市
        var cityName;
        function myFun1(result){
            cityName = result.name;
        }
        var myCity = new BMap.LocalCity();
        myCity.get(myFun1);
        var myValue;
        ac.addEventListener("onconfirm", function(e) {    //鼠标点击下拉列表后的事件
            var _value = e.item.value;
            myValue = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
            G("searchResultPanel").innerHTML ="onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;
            setPlace(myValue);
        });

        //定位
        function setPlace(targetCity){
            map.clearOverlays();    //清除地图上所有覆盖物
            function myFun(){
                var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
                map.centerAndZoom(pp, 18);
                map.addOverlay(new BMap.Marker(pp));    //添加标注
            }
            var local = new BMap.LocalSearch(map, { //智能搜索
                onSearchComplete: myFun
            });
            local.search(targetCity);
        }
    </script>
</block>