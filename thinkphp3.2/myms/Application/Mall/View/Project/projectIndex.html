<extend name="Public:base" />
<block name="css-customize">
    <link rel="stylesheet" type="text/css" href="PUBLIC_CSS/home/mall.css">
</block>
<block name="content">
    <!-- S= 轮播图 -->
    <div id="slider">
        <div class='swipe-wrap'>
            <div><img src="PUBLIC_IMG/home/slide/banner.jpg" /></div>
            <div><img src="PUBLIC_IMG/home/slide/diamond_watches.jpg" /></div>
            <div><img src="PUBLIC_IMG/home/slide/red_wine.jpg" /></div>
        </div>
        <ul class="position">
            <li class="on"></li>
            <li></li>
            <li></li>
            <li></li>
        </ul>
    </div>
    <nav class="f24">
        <ul class="common_top_nav">
            <volist name="pCatList" id="vo">
                <li class="categoryId" value="{$vo.id}">{$vo.name}</li>
            </volist>
            <input class="checkedId" type="hidden" value="{$categoryId}">
        </ul>
    </nav>
    <input type="hidden" class="project_position" value="project_index">
    <div class="content "  ></div>
    <!-- 隐藏区 -->
    <div style="display:none">
        <div id="loading">
            <div class='loading'><img src='PUBLIC_IMG/home/loading.gif' alt='loading'></div>
        </div>
    </div>
    <include file="Public/footer" />
    <include file="Public/cart" />
</block>
<block name="js-customize">
    <script type="text/javascript" src="PUBLIC_JS/home/cart.js"></script>
</block>
<block name="script">
    <script type="text/javascript">
        //加载商品列表
        function getPage(obj,currentPage,pageSize) {
            var url = MODULE+'/Project/projectList';
            var postData = {};
            postData.p = currentPage ?  currentPage : 1;
            postData.pageSize = pageSize ?  pageSize : 4;
            if(obj){
                postData.categoryId = $(obj).prev().find('li:first').data('categoryid');
                postData.buyType = $(obj).prev().find('li:first').data('buytype');
            }else{
                postData.position=$('.project_position').val();
            }

            $.ajax({
                url: url,
                data: postData,
                type: 'get',
                beforeSend: function(){
                    $(obj).html($('#loading').html());
                },
                success: function(data){
                    if(data.status == 0){
                        dialog.error(data.info);
                    }else{
                        if(obj){
                            $(obj).prev().find('li:last').after(data);
                            var page = $(obj).data('page')+1;
                            $(obj).data('page',page);
                        }else{
                            $('.content').html(data);
                        }
                    }
                },
                complete: function(){
                    $(obj).html('查看更多<i></i>')
                }
            });
        }

        /**
         * 继续加载
         * */
        var before_request = 1; // 上一次请求是否已经有返回来, 有才可以进行下一次请求
        var currentCatId = 0;
        function getMoreGoods(catId,type){
            var url = MODULE+'/Project/projectList';
            var getData = {};
            if(before_request == 0 && catId == currentCatId ){
                return false;
            }// 上一次请求没回来 不进行下一次请求
            if(catId != currentCatId || type == 1){
                page = 1;
            }
            before_request = 0;
            getData.pageSize = 4;
            getData.p = page++ ;
            getData.catId =  catId;

            $.ajax({
                type : 'get',
                data: getData,
                url:url,

                beforeSend: function(){
                    $('.content').append($('#loading').html());
                },

                success: function(data)
                {
                    if(type == 1){
                        $('.content').html(data);
                        before_request = 1;
                    }else{
                        if(data.status == 0){
                            dialog.error(data.info);
                            before_request = 0;
                        }else {
                            $('.content >div>ul>li:last').after(data);
                            before_request = 1;
                        }
                    }


                    currentCatId = catId;
                },
                complete:function(){
                    $('.loading').remove();
                }
            });
        }

        $(function(){
//            //初始化
//            getPage();
//
//            //查看更多
//            $('body').on('click','.view_more',function () {
//                var _this = $(this);
//                var currentPage = _this.data('page');
//                getPage(_this,currentPage)
//            });
//
//            //切换分类商品列表
//            var categoryId = $('.checkedId').val();
//            $('.categoryId').click(function () {
//                var catId = $(this).val();
//                var url_ajax = CONTROLLER+'/projectList';
//                $(".content").html($('#loading').html());
//                $.get(url_ajax, {catId:catId}, function(data) {
//                    $('.content').html(data);
//                });
//            });
//            $('.categoryId').each(function(){
//                if($(this).val() == categoryId){
//                    $(this).addClass('current');
//                }
//            });

            //初始化
            var categoryId = $('.checkedId').val();
            if(categoryId){
                var type = 1;//单个分类产品初始化
                getMoreGoods(categoryId,type);
            }else{
                getPage();
            }
            //查看更多
            $('body').on('click','.view_more',function () {
                var _this = $(this);
                var currentPage = _this.data('page');
                getPage(_this,currentPage)
            });
            //切换分类商品列表
            $('.categoryId').click(function () {
                var catId = $(this).val();
                var type =1;//单个分类产品初始化
                getMoreGoods(catId,type);
            });
            $('.categoryId').each(function(){
                if($(this).val() == categoryId){
                    $(this).addClass('current');
                }
            });
            //下拉加载更多
            $(window).on('scroll',function(){
                if($(document).scrollTop()+$(window).height()>=$(document).height()){
                    $('.categoryId').each(function(){
                        if($(this).hasClass('current')){
                            var catId = $(this).val();
                            getMoreGoods(catId);
                        }
                    });
                }
            });


            //滑动轮播
            var elem = document.getElementById('slider');
            window.mySwipe = Swipe(elem, {
                auto: 2500,
                callback: function(index,element){
                    //回调函数
                    $(".position li").eq(index).addClass("on").siblings().removeClass("on");
                }
            });
            $(".position li").click(
                    function () {
                        mySwipe.slide($(this).index());
                    }
            );
            tab_down('.common_top_nav li','.common_contents .common_tablist_wrap','click');
        })
    </script>

</block>