
<extend name="Public:base" />

<block name="css-customize">
    <link rel="stylesheet" type="text/css" href="PUBLIC_CSS/home/mall.css">
</block>
<block name="content">
    <!--指定收货人模板-->
    <div id="consigneeInfoList" style="display: none;">
        <notempty name="addressList">
            <ul class="consigneeList">
                <volist name="addressList" id="vo">
                    <if condition="$vo.id eq $orderInfo.address_id ">
                        <li class="current" data-address="" data-addressid="{$vo.id}">
                            <else />
                        <li class="" data-address="" data-addressid="{$vo.id}">
                    </if>
                        <if condition="$vo.is_default eq 1 ">
                            <span class="default_address">[默认地址]</span>
                            <else />
                            <span class="default_address">[可选地址]</span>
                        </if>
                        <div>收货人姓名：<span class="consigneeName">{$vo.consignee}</span></div>
                        <div>收货人手机号：<span class="consigneePhone">{$vo.mobile}</span></div>
                        <div>收货人地址：<span class="consigneeAddress">{$vo.district}{$vo.address}</span></div>
                    </li>
                </volist>
            </ul>
        </notempty>
    </div>
    <article class="msh_product_picture f24">
        <section class="purchase_head_title">
            <h2>采购单详情</h2>
        </section>
        <section class="purchase_order_list">
            <ul>
                <li>
                    <div>
                        订单号码：
                        <span>[{$orderInfo.order_sn}]</span>
                    </div>
                    <div>
                        下单时间：
                        <span>{$orderInfo.create_time|date="Y-m-d H:i:s",###}</span>
                    </div>
                    <div>
                        订单金额：
                        <span>￥{$orderInfo.order_amount}</span>
                    </div>
                    <div>
                        订单状态：
                        <if condition="$orderInfo.order_state eq 10">
                            <span class="order_in_stock">未付款</span>
                        </if>
                        <if condition="$orderInfo.order_state eq 20">
                            <if condition="($groupBuy.shipments eq 0) and ($orderInfo.order_type eq 1)">
                                <span class="order_in_stock">团购中</span>
                                <else />
                                <span class="order_in_stock">备货中</span>
                            </if>
                        </if>
                        <if condition="$orderInfo.order_state eq 30">
                            <span class="order_in_stock">已发货</span>
                        </if>
                        <if condition="$orderInfo.order_state eq 40">
                            <if condition="$orderInfo.evaluation_state eq 0">
                                <span class="order_in_stock">未评分评价</span>
                            </if>
                            <if condition="$orderInfo.evaluation_state eq 1">
                                <span class="order_in_stock">已评分评价</span>
                            </if>
                            <if condition="$orderInfo.evaluation_state eq 2">
                                <span class="order_in_stock">评分评价已关闭</span>
                            </if>
                        </if>
                        <if condition="$orderInfo.order_state eq 0">
                            <span class="order_in_stock">已取消</span>
                        </if>
                        <if condition="$orderInfo.order_state eq 50">
                            <span class="order_in_stock">售后</span>
                        </if>
                    </div>
                    <div>
                        收货人姓名：
                        <span class="detailConsigneeName">{$address.consignee}</span>
                    </div>
                    <div>
                        收货人手机号：
                        <span class="detailConsigneePhone">{$address.mobile}</span>
                    </div>
                    <div>
                        收货人地址：
                        <span class="detailConsigneeAddress">{$address.district}{$address.address}</span>
                    </div>
                </li>
            </ul>
        </section>
        <div class="purchase_package_wrapper f24">
            <div class="purchase_package_list">
                <input type="hidden" class="goodsId" value="{$goodsList[0].id}">
                <notempty name="orderGoods">
                    <ul>
                        <volist name="orderGoods" id="vo">
                            <li>
                                <if condition="$vo.type eq 1">
                                    <a class="purchase_goods_img" href="{:U('Goods/goodsInfo',array('goodsId'=> $vo['foreign_id']))}">
                                </if>
                                <if condition="$vo.type eq 2">
                                    <a class="purchase_goods_img" href="{:U('Project/projectInfo',array('projectId'=> $vo['foreign_id']))}">
                                </if>
                                    <notempty name="vo.img">
                                        <img src="UPLOADS_IMG/{$vo.img}" alt="">
                                        <else />
                                        <img src="PUBLIC_IMG/common/default/purchase100_default.jpg" alt="">
                                    </notempty>
                                </a>
                                <div class="purchase_goods_info">
                                    <p>{$vo.foreign_name}</p>
                                    <p>采购箱每箱含20单品盒 每盒装12g*20条</p>
                                    <div>
                                       <span class="purchase_price">￥{$vo.price}</span>
                                        <del>￥{$vo.price}</del>
                                    </div>
                                    <div class="purchase_goods_num">
                                        <span>{$vo.num}</span>
                                    </div>
                                </div>
                            </li>
                        </volist>
                    </ul>
                </notempty>
            </div>
        </div>
    </article>
    <include file="Public/footerOrder" />
</block>
<block name="script">
    <script type="text/javascript">
        $(function(){
            //立即计算
            $('body').on('click','.payNow',function () {
                var orderSn = '{$orderInfo.order_sn}';
                var payInfo = orderSn+',myms';
                var url = APP + '/Home/Payment/pay/payInfo/'+ payInfo;
                location.href = url;
            });

            var consigneeInfoList=$('#consigneeInfoList').html();
            var orderSn = '{$orderInfo.order_sn}';
            var addressId;
            $('body').on('click','.editAddress',function(){
                var consigneeInfoObject={};
                layer.open({
                    btn:['确定','取消'],
                    title:['指定收货人','border-bottom:1px solid #d9d9d9;'],
                    className:'consigneeInfoList_layer',
                    content:consigneeInfoList,
                    success:function(){
                        $('.consigneeList li').on('click',function(){
                            $(this).addClass('current').siblings().removeClass('current');
                            consigneeInfoObject={
                                consigneeName:$(this).find('.consigneeName').text(),
                                consigneePhone:$(this).find('.consigneePhone').text(),
                                consigneeAddress:$(this).find('.consigneeAddress').text()
                            };
                            $(this).data('address',consigneeInfoObject);
                            console.log(consigneeInfoObject);
                        });

                        $.each($('.consigneeInfoList_layer li'),function(i,val){
                            if($(this).data('addressid')==addressId){
                                $(this).addClass('current').siblings().removeClass('current');
                            }
                        });

                    },
                    yes:function(index){
                        $('.detailConsigneeName').text(consigneeInfoObject.consigneeName);
                        $('.detailConsigneePhone').text(consigneeInfoObject.consigneePhone);
                        $('.detailConsigneeAddress').text(consigneeInfoObject.consigneeAddress);
                         $.each($('.consigneeInfoList_layer li'),function(i,val){
                            if($(this).hasClass('current')){
                                addressId = $(this).data('addressid');
                            }
                        });
                        $.post(CONTROLLER+'/changeOrderAddress',{addressId:addressId,orderSn:orderSn},function (msg) {
                            if(msg.status == 1){
                                dialog.error(msg.info);
                            }
                            if(msg.status == 0){
                                dialog.error(msg.info);
                            }
                        },'json');
                        layer.close(index);
                    }
                })     
            });
            //通知平台收货
            $('body').on('click','.inform',function(){
                layer.open({
                    content:'已通知平台<br/>我收到订单货品了',
                    btn:'确定',
                    yes:function(index){
                        $.post(CONTROLLER+'/informToPlatform ',{orderSn:orderSn},function (msg) {
                            if(msg.status == 1){
                                dialog.error(msg.info);
                                $('.group_cart_nav a').text('去评分评价').removeClass('inform').addClass('evaluate');
                            }
                            if(msg.status == 0){
                                dialog.error(msg.info);
                            }
                        },'json');
                        layer.close(index);
                    }
                })
            });
            //团购分享给好友
            $('body').on('click','.share',function(){
                var groupbuy_sn = '{$groupBuy.groupbuy_sn}';
                var goodsId = $('.goodsId').val();
                var url = MODULE+'/Goods/goodsInfo/goodsId/'+goodsId +'/groupbuy_sn/'+ groupbuy_sn+'/shareType/'+1;
                location.href = url;
            });
            //跳转到评价
            $('body').on('click','.evaluate',function(){
                var url = MODULE+'/UserCenter/evaluate/';
                location.href = url;
            })
        })
    </script>
</block>



