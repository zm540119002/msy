<style lang="less" scoped>
    .product-select{
        border-bottom:none;
        padding:0.12rem;
        margin:0.12rem;
        background-color: #ffffff;
    }.product-select	div.left{
        width:40%;
    }.product-select div.middle{
        width:20%;
    }.product-select div.right{
        width:40%;
    }.product-select div.right div:last-child{
        height:20%;
    }.product-select div.middle div{
        height:50%;
    }.product-select img.left{
        width:100%;
    }.two-line-apostrophe {
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        word-break: break-all;
    }.four-line-apostrophe {
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
        word-break: break-all;
    }.check_all {
         -webkit-appearance: checkbox;
     }
</style>
<!-- 产品选择器 -->
<template id="product_select_tpl">
    <li v-if="type==0">
        <div class="product-select">
            <div class=""><p></p></div>
            <div class="columns_flex l-r-sides">
                <div class="left">
                    <a class="p_img" :href="'/index/Goods/detail/id/' + product_id">
                        <img class="left" :src="product_src?('public_uploads/' + product_src):('api_common_img/default/no_pic_100.jpg') " alt="">
                    </a>
                </div>
                <div  class="right">
                    <div class="product_name">
                        <p class="text-intro">{{product_name}}</p>
                    </div>
                    <div class="quantity_wrapper selected-number columns_flex l-r-sides">
                        <div><span class="red deal_price">￥{{deal_price}}</span></div>
                        <div><a href="javascript:void(0);" class="add_cart add_cart_i" @click="plusCart" :data-jump_url="add_cart_url"><i></i></a></div>
                    </div>
                </div>
            </div>
        </div>
    </li><li v-else-if="type==1">
        <div class="product-select">
            <div class="columns_flex l-r-sides"><p><span class="red deal_price">￥{{deal_price}}</span></p></div>
            <div class="columns_flex l-r-sides">
                <div class="left">
                    <a class="p_img" :href="'/index/Goods/detail/id/' + product_id">
                        <img class="left" :src="product_src?('public_uploads/' + product_src):('api_common_img/default/no_pic_100.jpg') " alt="">
                    </a>
                </div>
                <div class="middle">
                    <div></div>
                    <div class="red subtotal_amount">￥{{ parseFloat(subtotal_amount).toFixed(2) }}</div>
                </div>
                <div  class="right">
                    <div class="product_name">
                        <p class="text-intro">{{product_name}}</p>
                    </div>
                    <div class="quantity_wrapper selected-number">
                        <a href="javascript:void(0);" class="reduce" @click="reduce">-</a>
                        <input type="text" :value="buy_quantity" class="f24 product_count" readonly="readonly">
                        <a href="javascript:void(0);" class="plus" @click="plus">+</a>
                    </div>
                </div>
            </div>
        </div>
    </li><li v-else-if="type==2">
        <div class="product-select">
            <div class="columns_flex l-r-sides">
                <p><span class="red deal_price">￥{{deal_price}}</span></p>
                <p v-if="display_quota">样品购买限额：<span class="quota">{{quota_quantity}}</span></p>
            </div>
            <div class="columns_flex l-r-sides">
                <div class="left">
                    <p>采购数量：(单位:{{specification_unit}})</p>
                    <p>
                        <span class="step-named">起订数量：</span>
                        <span class="step-quantity">{{init_quantity}}</span>
                        <span class="specification_unit">{{specification_unit}}</span>
                    </p>
                </div>
                <div class="middle">
                    <div></div>
                    <div class="red subtotal_amount">￥{{ parseFloat(subtotal_amount).toFixed(2) }}</div>
                </div>
                <div  class="right">
                    <div class="product_name">
                        <p class="text-intro">{{product_name}}</p>
                    </div>
                    <div class="quantity_wrapper selected-number">
                        <a href="javascript:void(0);" class="reduce" @click="reduce">-</a>
                        <input type="text" :value="buy_quantity" class="f24 product_count" readonly="readonly">
                        <a href="javascript:void(0);" class="plus" @click="plus">+</a>
                    </div>
                </div>
            </div>
        </div>
    </li><li v-else-if="type==3">
        <div class="product-select">
            <div class="columns_flex l-r-sides">
                <div class="left">
                    <div></div>
                    <div class="red subtotal_amount">￥<span class="">{{ parseFloat(subtotal_amount).toFixed(2) }}</span></div>
                </div>
                <div class="right">
                    <div class="quantity_wrapper selected-number">
                        <a href="javascript:void(0);" class="reduce" @click="reduce">-</a>
                        <input type="text" :value="buy_quantity" class="f24 product_count" readonly="readonly">
                        <a href="javascript:void(0);" class="plus" @click="plus">+</a>
                    </div>
                </div>
            </div>
            <div class="product_name"><p class="two-line-apostrophe">{{product_name}}</p></div>
        </div>
    </li><li v-else-if="type==4"><!--用于购物车-->
        <input type="checkbox" class="item_checkbox check_item" v-model="checked" />
        <a href="" class="cart_goods_img" :href="'/index/Goods/detail/id/' + product_id">
            <img class="left common_default_img" :src="product_src?('public_uploads/' + product_src):('api_common_img/default/no_pic_100.jpg') " alt="">
        </a>
        <div class="cart_list_r">
            <p>{{product_name}}</p>
            <div>商品规格：<span>{{specification}}</span></div>
            <div class="commodity_purchaser f24"><span class="pink">￥{{deal_price}}</span></div>
            <div class="purchase_goods_num cart_goods_operate">
                <div class="quantity_wrapper selected-number">
                    <a href="javascript:void(0);" class="add_cart reduce" @click="reduceCart" :data-jump_url="add_cart_url">-</a>
                    <input type="text" :value="buy_quantity" class="f24 product_count" readonly="readonly">
                    <a href="javascript:void(0);" class="add_cart plus" @click="plusCart" :data-jump_url="add_cart_url">+</a>
                </div>
                <a href="javascript:void(0);" class="delete_order goodsDel delete_cart" @click="delCart" :data-jump_url="del_cart_url">删除</a>
            </div>
        </div>
    </li>
</template>
<script type="text/javascript">
    $(function(){
        Vue.component('product-select', {
            template:'#product_select_tpl',
            props: {
                product_id: {type: [String, Number],default:0,required: true},
                product_name: {type: String,default: ''},
                specification: {type: String,default: ''},
                specification_unit: {type: String,default: '盒'},
                product_src: {type: String,default: ''},
                quota_quantity: {type: Number,default: 1},
                type: {type: Number,default: 1},
                deal_price: {type: Number,required: true},
                init_quantity: {type: Number,default: 1},
                step_quantity: {type: Number,default: 1},
                display_quota: {type: Boolean,default: false},
                init_checked: {type: Boolean,default: true},
                productInfo: {type: Array,default:function(){
                    let arr = [];
                    arr['eg'] = '默认值示范';
                    return arr;
                }}
            },data: function () {
                return {
                    buy_quantity:this.init_quantity,
                    buy_quantity_reduce_trigger:true,
                    subtotal_amount:0,
                    checked:this.init_checked,
                    checked_operation_type:'edit',
                    add_cart_url:'{:url("Cart/addCart")}',
                    del_cart_url:'{:url("Cart/del")}'
                };
            },methods: {
                subtotal_amount_calculate:function(){
                    this.subtotal_amount = this.deal_price * this.buy_quantity;
                },delCart:function(event){
                    if(this.buy_quantity_reduce_trigger){
                        this.buy_quantity_reduce_trigger = false;
                    }else{
                        return false;
                    }
                    let postData = {
                        goodsList:[{
                            goods_id: this.product_id,
                            num: -this.buy_quantity
                        }]
                    };
                    let _thisJquery = $(event.currentTarget);
                    let _thisVue = this;
                    let config = {
                        clickObj:_thisJquery,
                        vueObj:_thisVue,
                        postData:postData,
                        reduce:true
                    };
                    asyncVerify(config);
                },reduce: function () {
                    //如果开启了样品购买限额
                    if(this.display_quota){
                        if((this.buy_quantity-this.step_quantity)<this.init_quantity){
                            this.buy_quantity = this.init_quantity;
                        }else{
                            this.buy_quantity -= this.step_quantity;
                        }
                    }else if(this.buy_quantity>this.init_quantity){
                        this.buy_quantity -= this.step_quantity;
                    }
                },plus: function () {
                    //如果开启了样品购买限额
                    if(this.display_quota){
                        if((this.buy_quantity+this.step_quantity)>this.quota_quantity){
                            this.buy_quantity = this.quota_quantity;
                        }else{
                            this.buy_quantity += this.step_quantity;
                        }
                    }else{
                        this.buy_quantity += this.step_quantity;
                    }
                },reduceCart: function (event) {
                    if(this.buy_quantity_reduce_trigger && this.buy_quantity>1){
                        this.buy_quantity_reduce_trigger = false;
                    }else{
                        return false;
                    }
                    let postData = {
                        goodsList:[{
                            goods_id: this.product_id,
                            num: -this.step_quantity
                        }]
                    };
                    let _thisJquery = $(event.currentTarget);
                    let _thisVue = this;
                    login_success_callback_private = function(){
                        _thisJquery.click()
                    };
                    register_success_callback_private = function(){
                        _thisJquery.click()
                    };
                    let config = {
                        clickObj:_thisJquery,
                        vueObj:_thisVue,
                        postData:postData,
                        reduce:true,
                        func:function(){
                            _thisJquery.click();
                        }
                    };
                    asyncVerify(config);
                },plusCart: function (event) {
                    let postData = {
                        goodsList:[{
                            goods_id: this.product_id,
                            num: this.step_quantity
                        }]
                    };
                    let _thisJquery = $(event.currentTarget);
                    let _thisVue = this;
                    login_success_callback_private = function(){
                        _thisJquery.click()
                    };
                    register_success_callback_private = function(){
                        _thisJquery.click()
                    };
                    let config = {
                        clickObj:_thisJquery,
                        vueObj:_thisVue,
                        postData:postData,
                        func:function(){
                            _thisJquery.click();
                        }
                    };
                    asyncVerify(config);
                },editCheckItem:function(param){
                    this.checked = param;
                }
            },created: function(){
                let _this = this;
                _this.subtotal_amount_calculate();
                //触发-产品选择器初始化-事件
                bus.$emit('product_select_init',_this);
                //监听-底部购物车全选改变-事件
                bus.$on('footer_cart_check_all_change', function(param){
                    _this.editCheckItem(param);
                });
            },watch: {
                buy_quantity: {
                    handler(newVal, oldVal) {
                        this.subtotal_amount_calculate();
                        if(typeof(oldVal) !== "undefined"){
                            this.increment_buy_quantity = parseInt(newVal) - parseInt(oldVal?oldVal:0);
                            //触发--产品选择器购买数量改变-事件
                            bus.$emit('product_select_buy_quantity_change',this);
                        }
                    },
                    deep: false,
                    immediate: true
                },checked: {
                    handler(newVal, oldVal) {
                        if(typeof(oldVal) !== "undefined"){
                            //触发-产品选择器复选框改变-事件
                            bus.$emit('product_select_check_item_change',this);
                        }
                    },
                    deep: false,
                    immediate: true
                }
            }
        });
    });
</script>
<!-- 底栏购物菜单 -->
<template id="footer-cart-menu_tpl">
    <footer class="f24 ">
        <div class="group_cart_nav">
            <a href="javascript:void(0);" v-for="menu in menus" :class="menu.class">
                {{menu.name}}
                <!-- 全选 -->
                <div v-if="menu.class.indexOf('checked_all')!==-1" class="checked_all">
                    <input type="checkbox" class="check_all" v-model="checked" @click="checkAll" id="check_all"/>
                    <label for="check_all">全选</label>
                </div>
                <!-- 总金额 -->
                <div v-else-if="menu.class.indexOf('amount')!==-1" class="amount">
                    <span class="total_amount">￥{{ parseFloat(total_amount).toFixed(2) }}</span>
                </div>
                <!-- 购物篮 -->
                <div v-else-if="menu.class.indexOf('add_cart_icon')!==-1" class="add_cart_icon" @click="jump_url" :data-jump_url="menu.action">
                    <span class="add_num current" v-if="cart_num > 99">99+</span>
                    <span class="add_num current" v-else-if="cart_num > 0">{{ cart_num }}</span>
                    <span class="add_num current" v-else></span>
                </div>
                <!-- 加入购物车 -->
                <div v-else-if="menu.class.indexOf('add_cart')!==-1" class="add_cart" @click="addCart" :data-jump_url="menu.action">
                    <span class="s_i"></span>
                </div>
                <!-- 立即购买 -->
                <div v-else-if="menu.class.indexOf('buy_now')!==-1" class="buy_now" @click="addCart" :data-jump_url="menu.action">
                    <span class="s_i"></span>
                </div>
                <!-- 去结算 -->
                <div v-else-if="menu.class.indexOf('settlement')!==-1" class="buy_now" @click="addCart" :data-jump_url="menu.action">
                    <span class="s_i"></span>
                </div>
                <!-- 提交订单 -->
                <div v-else-if="menu.class.indexOf('confirm_order')!==-1" class="confirm_order" @click="addCart" :data-jump_url="menu.action">
                    <span class="s_i"></span>
                </div>
                <!-- 默认 -->
                <div v-else class="default">
                    <span class="s_i"></span>
                </div>
            </a>
        </div>
    </footer>
</template>
<script type="text/javascript">
    $(function(){
        var unlockingFooterCart = '{$unlockingFooterCart|raw}';
        if(unlockingFooterCart){
            unlockingFooterCart = JSON.parse(unlockingFooterCart);
            Vue.component('footer-cart-menu', {
                template:'#footer-cart-menu_tpl',
                props: {
                    type: {type: Number,default: 1},
                    cart_init_num: {type: Number,default: 0},
                    init_checked: {type: Boolean,default: false},
                    buy_now_call_back: {type: Function,default: function(param){
                        console.log(param);
                    }}
                },data: function () {
                    return {
                        total_amount:0,
                        cart_num:this.cart_init_num,
                        checked:this.init_checked,
                        checkItemList:[],
                        menus: unlockingFooterCart.menu,
                        postData:{
                            goodsList:[]
                        }
                    }
                },methods: {
                    total_amount_init:function (param) {
                        if(this.type==4 && !param.checked){
                            return false;
                        }
                        this.total_amount += param.subtotal_amount;
                    },total_amount_calculate:function (param) {
                        if(this.type==4 && !param.checked){
                            return false;
                        }
                        this.total_amount += param.deal_price * param.increment_buy_quantity;
                    },total_amount_calculate_with_checked:function (param) {
                        if(param.checked){
                            this.total_amount += param.subtotal_amount;
                        }else{
                            this.total_amount -= param.subtotal_amount;
                        }
                    },jump_url:function (event) {
                        let obj = $(event.currentTarget);
                        let jump_url = obj.data('jump_url');
                        if(jump_url){
                            location.href = jump_url;
                        }
                    },addCart:function(event){
                        let _thisJquery = $(event.currentTarget);
                        let _thisVue = this;
                        login_success_callback_private = function(){
                            _thisJquery.click()
                        };
                        register_success_callback_private = function(){
                            _thisJquery.click()
                        };
                        //前端验证
                        if((
                                (_thisJquery.attr('class')=='add_cart' //加入购物车
                                || _thisJquery.attr('class')=='buy_now' //立即购买
                                || _thisJquery.attr('class')=='settlement' //去结算
                                ) && !_thisVue.postData.goodsList.length)
                        ){ //提交商品为空验证
                            dialog.error('请选择商品！');
                            return false;
                        }
                        let config = {
                            clickObj:_thisJquery,
                            postData:_thisVue.postData,
                            componentFooterCartMenu:_thisVue,
                            func:function(){
                                _thisJquery.click();
                            }
                        };
                        asyncVerify(config);
                    },editProductList:function(param){
                        if(this.type==4 && !param.checked){
                            return false;
                        }
                        let productInfo = {
                            'goods_id':param.product_id,
                            'num':param.buy_quantity
                        };
                        //产品是否存在产品列表，默认不存在
                        let existSign = false;
                        for(let i = 0,len = this.postData.goodsList.length; i < len; i++){
                            //产品已存在产品列表，则修改或删除
                            if(this.postData.goodsList[i]['goods_id'] == param.product_id){
                                if(param.buy_quantity<=0){
                                    Vue.delete(this.postData.goodsList,i);
                                }else{
                                    this.postData.goodsList[i]['num'] = param.buy_quantity;
                                }
                                existSign = true;
                                break;
                            }
                        }
                        //产品不存在产品列表，则添加
                        if(!existSign && param.buy_quantity>0){
                            this.postData.goodsList.push(productInfo);
                        }
                    },editProductListWithChecked:function(param){
                        let productInfo = {
                            'goods_id':param.product_id,
                            'num':param.buy_quantity
                        };
                        let existSign = false;
                        for(let i = 0,len = this.postData.goodsList.length; i < len; i++){
                            if(this.postData.goodsList[i]['goods_id'] == param.product_id){
                                if(!param.checked){
                                    Vue.delete(this.postData.goodsList,i);
                                }
                                existSign = true;
                                break;
                            }
                        }
                        //产品不存在产品列表，则添加
                        if(!existSign && param.checked && param.buy_quantity>0){
                            this.postData.goodsList.push(productInfo);
                        }
                    },editCheckItemList:function(param){
                        let tmp = {
                            product_id:param.product_id,
                            checked:param.checked
                        };
                        let find = false;
                        for(let i = 0,len = this.checkItemList.length; i < len; i++){
                            if(this.checkItemList[i].product_id == param.product_id){
                                if(param.checked_operation_type=='delete'){ //删除选择状态
                                    Vue.delete(this.checkItemList,i);
                                }else if(param.checked_operation_type=='edit'){ //修改选择状态
                                    this.checkItemList[i].checked = param.checked;
                                    this.checkItemList.push({
                                        product_id:param.product_id,
                                        checked:param.checked
                                    });
                                    find = true;
                                    break;
                                }
                            }
                        }
                        if(!find){
//                            this.checkItemList.push(tmp);
                        }
                        this.editCheckAll(param);
                    },editCheckAll:function(param){
                        if(param.checked_operation_type=='edit'){ //修改选择状态
                            this.checked = true;
                            for(let i = 0,len = this.checkItemList.length; i < len; i++){
                                if(!this.checkItemList[i].checked){
                                    this.checked = false;
                                    break;
                                }
                            }
                        }
                    },checkAll:function(){
                        this.checked = !this.checked;
                        for(let i = 0,len = this.checkItemList.length; i < len; i++){
                            this.checkItemList[i].checked = this.checked;
                        }
                        //触发-底部购物车全选改变-事件
                        bus.$emit('footer_cart_check_all_change',this.checked);
                    }
                },created:function(){
                    let _this = this;
                    //监听-产品选择器初始化-事件
                    bus.$on('product_select_init', function(param){
                        _this.total_amount_init(param);
                        _this.editProductList(param);
                        _this.editCheckItemList(param);
                    });
                    //监听-产品选择器复选框改变-事件
                    bus.$on('product_select_check_item_change', function(param){
                        _this.total_amount_calculate_with_checked(param);
                        _this.editProductListWithChecked(param);
                        _this.editCheckItemList(param);
                    });
                    //监听-产品选择器购买数量改变-事件
                    bus.$on('product_select_buy_quantity_change', function(param){
                        _this.total_amount_calculate(param);
                        _this.editProductList(param);
                    });
                }
            });
        }
    });
</script>