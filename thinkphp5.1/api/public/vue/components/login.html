<style lang="less" scoped>
    .loginTab{
        display: none;
    }.show{
        display: block;
    }
</style>
<!-- 模板 -->
<template id="login_tpl">
    <section class="userInfoWrapper">
        <div class="ucenter_logo">
            <img src="api_common_img/ucenter_logo.png" alt="">
        </div>
        <div class="f24 bomb_box">
            <ul class="loginNav">
                <li class="switch_current" :class="{current:true}">登录</li>
                <li class="switch_current" class="switch_current" :class="{current:false}">注册/重置密码</li>
            </ul>
            <form class="loginTab" :class="{show:true}">
                <div class="login_item">
                    <div class="columns_flex">
                        <span>中国(+86)</span>
                        <input class="username user_phone input-filed" type="tel" placeholder="请输入手机号码" :value="currentValue" @input="handleInput">
                    </div>
                </div>
                <div class="login_item">
                    <div class="columns_flex">
                        <input class="input-filed password" type="password" placeholder="密码" v-model.trim="loginPostData.password">
                    </div>
                </div>
                <a href="javascript:void(0);" class="entry-button btn_login">登录</a>
            </form>
            <form class="loginTab" :class="{show:false}">
                <div class="error_tipc" ></div>
                <div class="login_item">
                    <div class="columns_flex">
                        <span>中国(+86)</span>
                        <input class="username user_phone input-filed" type="tel" placeholder="请输入手机号码" v-model.trim="registerPostData.mobile_phone">
                    </div>
                </div>
                <div class="smsLogin login_wrap">
                    <div class="login_item">
                        <div class="columns_flex l-r-sides">
                            <input type="text" class="tel_code input-filed" placeholder="请输入收到的验证码" v-model.trim="registerPostData.captcha">
                            <a href="javascript:void(0);" class="send_sms">获取验证码</a>
                        </div>
                    </div>
                </div>
                <div class="login_item">
                    <div class="columns_flex">
                        <input class="input-filed password" autocomplete="new-password" type="password" placeholder="设置密码"
                               v-model.trim="registerPostData.password">
                    </div>
                </div>
                <a href="javascript:void(0);" class="entry-button btn_register">确定</a>
            </form>
        </div>
    </section>
</template>
<script type="text/javascript">
    var component_login = null;
    $(function(){
        //表单切换
        component_login = Vue.component('login', {
            template:'#login_tpl',
            props: {
                login_succeed_call_back: {type: Function,default: function(param){
                    dialog.success('成功');
                }},login_failed_call_back: {type: Function,default: function(param){
                    dialog.error(param.info);
                }},register_succeed_call_back: {type: Function,default: function(param){
                    dialog.success('成功');
                }},register_failed_call_back: {type: Function,default: function(param){
                    dialog.error(param.info);
                }}
            },
            data: function () {
                return {
                    loginPostData:{
                        mobile_phone:'',
                        password:'',
                        captcha:''
                    },registerPostData:{
                        mobile_phone:'',
                        password:'',
                        captcha:''
                    }
                };
            },
             computed:{
    currentValue:function () {
      return this.value
    }
  },
            methods: {
                 handleInput(event) {
        var value = event.target.value;
        this.currentValue = value;
        this.$emit('input', value); //触发 input 事件，并传入新值
    },
                switchCurrent:function(param){
                    let _thisLi = param.obj;
                    _thisLi.length && _thisLi.addClass("current").siblings().removeClass("current");
                    let _thisIndex = _thisLi.index();
                    $.each(_thisLi.parents('.userInfoWrapper').find('form'),function(index){
                        if(index==_thisIndex){
                            $(this).addClass("show").siblings().removeClass("show");
                        }
                    });
                },login:function(param){
                    console.log(this.loginPostData.mobile_phone);
                    let content='';
                    if(!register.phoneCheck(this.loginPostData.mobile_phone)){
                        content='请输入正确手机号码';
                    }else if(!register.pswCheck(this.loginPostData.password)){
                        content = "请输入6-16数字或字母的密码";
                    }
                    if(content){
                        dialog.error(content);
                        return false;
                    }
                    let url = domain + 'ucenter/UserCenter/login';
                    let _this = this;
                    $.ajax({
                        url: url,
                        data: this.loginPostData,
                        type: 'post',
                        beforeSend: function(xhr){
                            $('.loading').show();
                        },
                        error:function(xhr){
                            $('.loading').hide();
                            dialog.error('AJAX错误');
                        },
                        success: function(data){
                            $('.loading').hide();
                            if(data.status==0){
                                _this.login_failed_call_back(data);
                            }else if(data.status==1){
                                $.extend(param.login_success_callback_param,data);
                                if( (param.login_success_callback_private && $.isFunction(param.login_success_callback_private))
                                    || (param.login_success_callback_common && $.isFunction(param.login_success_callback_common)) ){
                                    param.login_success_callback_private && param.login_success_callback_private(param.login_success_callback_param);
                                    param.login_success_callback_common && param.login_success_callback_common(param.login_success_callback_param);
                                }else{
                                    _this.login_succeed_call_back(param.login_success_callback_param);
                                }
                            }
                        }
                    });
                },register:function(param){
                    console.log(this.registerPostData);
                    let content='';
                    if(!register.phoneCheck(this.registerPostData.mobile_phone)){
                        content='请输入正确手机号码';
                    }else if(!register.vfyCheck(this.registerPostData.captcha)){
                        content = "请输入正确的验证码";
                    }else if(!register.pswCheck(this.registerPostData.password)){
                        content = "请输入6-16数字或字母的密码";
                    }
                    if(content){
                        dialog.error(content);
                        return false;
                    }
                    let url = domain + 'ucenter/UserCenter/register';
                    let _this = this;
                    $.ajax({
                        url: url,
                        data: this.registerPostData,
                        type: 'post',
                        beforeSend: function(xhr){
                            $('.loading').show();
                        },
                        error:function(xhr){
                            $('.loading').hide();
                            dialog.error('AJAX错误');
                        },
                        success: function(data){
                            $('.loading').hide();
                            if(data.status==0){
                                _this.register_failed_call_back(data);
                            }else if(data.status==1){
                                $.extend(param.login_success_callback_param,data);
                                if( (param.register_success_callback_private && $.isFunction(param.register_success_callback_private))
                                        || (param.register_success_callback_common && $.isFunction(param.register_success_callback_common)) ){
                                    param.register_success_callback_private && param.register_success_callback_private(param.login_success_callback_param);
                                    param.register_success_callback_common && param.register_success_callback_common(param.login_success_callback_param);
                                }else{
                                    _this.register_succeed_call_back(param.register_success_callback_param);
                                }
                            }
                        }
                    });
                }
            },created:function(){
                let _this = this;
                //监听-切换当前-事件
                bus.$on('switchCurrent', function(param){
                    _this.switchCurrent(param);
                });
                //监听-登录-事件
                bus.$on('login', function(param){
                    _this.login(param);
                });
                //监听-注册-事件
                bus.$on('register', function(param){
                    _this.register(param);
                });
            }
        });
    });
</script>
<div id="loginDialogTpl" style="display: none">
    <div id="loginDialogRoot">
        <login></login>
    </div>
</div>
<script type="text/javascript">
    //登录-弹窗触发
    var loginDialogTriggerLayerIndex = 0;
    function loginDialogTrigger(){
        var content = $('#loginDialogTpl').html();
        loginDialogTriggerLayerIndex = layer.open({
            className:'loginLayer',
            type:1,
            shadeClose:false,
            content:content,
            btn:[''],
            success:function(index){
            },yes:function(index){
                layer.close(index);
            }
        });
    }
    var login_success_callback_common = function(param){
        layer.close(param.index);
    };
    var register_success_callback_common = function(){
        layer.close(param.index);
    };
    $(function(){
        $('body').on('click','.loginLayer .switch_current',function(){
            //触发-切换当前-事件
            let param = {
                obj:$(this)
            };
            bus.$emit('switchCurrent',param);
        });
        $('body').on('click','.loginLayer .btn_login',function(){
            //触发-登录-事件
            let login_success_callback_param = {
                index:loginDialogTriggerLayerIndex
            };
            let param = {
                login_success_callback_param:login_success_callback_param,
                login_success_callback_private:login_success_callback_private,
                login_success_callback_common:login_success_callback_common
            };
            bus.$emit('login',param);
        });
        $('body').on('click','.loginLayer .btn_register',function(){
            //触发-注册-事件
            let register_success_callback_param = {
                index:loginDialogTriggerLayerIndex
            };
            let param = {
                register_success_callback_param:register_success_callback_param,
                register_success_callback:register_success_callback
            };
            bus.$emit('register',param);
        });
        new Vue({
            el:'#loginDialogRoot',
            data:function(){
                return {};
            }
        });
    });
</script>