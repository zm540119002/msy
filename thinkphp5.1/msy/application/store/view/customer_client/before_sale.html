{extend name="template/base.html" /}
{block name="css-customize"}
{/block}
{block name="content"}
<!--对话框列表模板-->
<section id="chatListOtherTpl" style="display:none;">
    <li class="others">
        <div class="avatar">
            <img src="public_img/default/no_pic_40.jpg">
        </div>
        <div class="content">
            <p class="author"></p>
            <div class="msg"></div>
        </div>
    </li>
</section>
{include file="public/switch_factory_store" /}
<section class="specific_type separation-line">
    <div class="columns_flex f20 l-r-sides">
        <a href="{:url('CustomerClient/beforeSale')}" class="current">售前</a>
        <a href="{:url('Order/index')}">打单</a>
        <a href="{:url('Order/out')}">出仓</a>
        <a href="{:url('Order/delivery')}">发货/完成</a>
        <a href="{:url('Order/bill')}">填单</a>
        <a href="{:url('CustomerClient/afterSale')}">售后</a>
    </div>
</section>
<section class="f24 account-content-wrapper order-content-wrapper">
    <ul class="list"></ul>
</section>
</article>
{/block}
{block name="common"}
{include file="template/footer_menu_msy_store.html" /}
{include file="template/right_side_bar.html" /}
{/block}
{block name="footer"}{/block}
{block name="script"}
<script type="text/javascript">
    function on_message_call_back(data) {
    }
</script>
<script type="text/javascript" src="public_js/web-socket.js"></script>
<script type="text/javascript">
    $(function () {
        //页面初始化
        var config = {
            url: action
        };
        getList(config);
        //聊天对话框弹窗
        $('body').on('click','.list li',function(){
            var _this=$(this);
            var chatLayerContainer=_this.find('.chatLayerContainer');
            layer.open({
                className:'chatLayer',
                content:chatLayerContainer,
                type:1,
                anim:'up',
                btn:['','关闭'],
                success:function(){
                    var winH=$(document).height();
                    $('.chatLayer .layui-m-layercont').html(chatLayerContainer.html());
                    //设置信息已读
                    var postData = {};
                    postData.from_id = _this.find('ul').data('from_id');
                    postData.messageIds = [];
                    $.each(_this.find('li.others.unread'),function(){
                        postData.messageIds.push($(this).data('id'));
                    });
                    if(!postData.messageIds.length){
                        return false;
                    }
                    var url = domain + 'index/CustomerService/setToMessageRead';
                    $.ajax({
                        url: url,
                        data: postData,
                        type: 'post',
                        beforeSend: function(xhr){
                            $('.loading').show();
                        },
                        error:function(xhr){
                            $('.loading').hide();
                            dialog.error('AJAX错误');
                        },
                        success: function(data){
                            $('.loading').hide();
                            if(data.status==0){
                                dialog.error(data.info);
                            }else{
                                //成功
                                console.log(_this.find('li.others.unread'));
                                _this.find('.news_num').text('');
                               $.each(_this.find('li.others.unread'),function(){
                                   $(this).attr('class','others read');
                               });
                               //_this.find('li.others.unread').removeClass('unread').addClass('read');
//                                $.each(_this.find('li.others.unread'),function(){
//                                    $(this).attr('class','others read');
//                                });
//                                _this.find('li.others.unread').removeClass('unread').addClass('read');
                            }
                        }
                    });
                },
                no:function(){
                    chatLayerContainer.find('ul').html($('.chatLayer .chat_item').html());
                }
            });
        });
        //发送聊天内容
        $('body').on('click','.send_btn',function(){
            var _this=$(this).prev();
            if(!_this.val()){
                dialog.error('不能发送空内容！');
                return false;
            }
            var to_user_id = _this.parents('.chatLayer').find('ul').data('from_id');
            var postData = {to_user_id:to_user_id,content:_this.val()};
            var url = domain + 'index/CustomerService/sendMessage';
            $.ajax({
                url: url,
                data: postData,
                type: 'post',
                beforeSend: function(xhr){
                    $('.loading').show();
                },
                error:function(xhr){
                    $('.loading').hide();
                    dialog.error('AJAX错误');
                },
                success: function(data){
                    $('.loading').hide();
                    if(data.status==0){
                        dialog.error(data.info);
                    }else{
                        $('.chatLayer .chat_item').append(data);
                        _this.val('');
                    }
                }
            });
        });
        //删除
        $('body').on('click','.detele_chat',function(e){
            e.stopPropagation();
            var _thisLi=$(this).parent();
            var postData = {};
            postData.from_id = _thisLi.find('ul').data('from_id');
            postData.messageIds = [];
            $.each(_thisLi.find('li'),function(){
                postData.messageIds.push($(this).data('id'));
            });
            var url = domain + 'index/CustomerService/delMessage';
            $.ajax({
                url: url,
                data: postData,
                type: 'post',
                beforeSend: function(xhr){
                    $('.loading').show();
                },
                error:function(xhr){
                    $('.loading').hide();
                    dialog.error('AJAX错误');
                },
                success: function(data){
                    $('.loading').hide();
                    if(data.status==0){
                        dialog.error(data.info);
                    }else{
                        _thisLi.remove();
                    }
                }
            });
        });
    });
</script>
{/block}