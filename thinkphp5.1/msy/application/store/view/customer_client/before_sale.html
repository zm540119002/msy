{extend name="template/base.html" /}
{block name="css-customize"}
{/block}
{block name="content"}
<!--对话框列表模板-->
<section id="chatListTpl" style="display:none;">
    <li class="me">
        <div class="avatar">
            <img src="public_img/default/no_pic_40.jpg">
        </div>
        <div class="content">
            <div class="msg"></div>
        </div>
    </li>
</section>
<section id="chatListOtherTpl" style="display:none;">
    <li class="others">
        <div class="avatar">
            <img src="public_img/default/no_pic_40.jpg">
        </div>
        <div class="content">
            <p class="author">(小猫咪)</p>
            <div class="msg"></div>
        </div>
    </li>
</section>
{include file="public/switch_factory_store" /}
<section class="specific_type separation-line">
    <div class="columns_flex f20 l-r-sides">
        <a href="{:url('CustomerClient/beforeSale')}" class="current">售前</a>
        <a href="{:url('Order/index')}">打单</a>
        <a href="{:url('Order/out')}">出仓</a>
        <a href="{:url('Order/delivery')}">发货/完成</a>
        <a href="{:url('Order/bill')}">填单</a>
        <a href="{:url('CustomerClient/afterSale')}">售后</a>
    </div>
</section>
<section class="f24 account-content-wrapper order-content-wrapper">
    <ul class="list"></ul>
</section>
</article>
{/block}
{block name="common"}
{include file="template/footer_menu_msy_store.html" /}
{include file="template/right_side_bar.html" /}
{/block}
{block name="footer"}{/block}
{block name="script"}
<script type="text/javascript">
    $(function () {
        //页面初始化
        var config = {
            url: action
        };
        getList(config);
        //聊天对话框弹窗
        var chatListId;
        var touchY = 0;
        var longClick =0;
        $('.list li').on({
            touchstart:function(){
                longClick=0;
                timeOutEvent = setTimeout(function(){
                    //此处为长按事件-----在此显示遮罩层及删除按钮
                    longClick=1;//假如长按，则设置为1
                },500);
                var touch = e.touches[0];
                touchY = touch.clientY;
            },
            touchmove:function(){
                clearTimeout(timeOutEvent);
                timeOutEvent = 0;
                var touch = e.touches[0]
                if(Math.abs(touch.clientY - touchY) < 10){
                    e.preventDefault();
                }

            },
            touchend:function(){
                clearTimeout(timeOutEvent);//清除定时器   
                if(timeOutEvent!=0&& self.longClick==0){   
                    //这里写要执行的内容（尤如onclick事件）   
                    alert("你这是点击，不是长按");   
                    var _this=$(this);
                    var chatLayerContainer=_this.find('.chatLayerContainer');
                    layer.open({
                        className:'chatLayer',
                        content:chatLayerContainer,
                        type:1,
                        anim:'up',
                        btn:['','关闭'],
                        success:function(){
                            var winH=$(document).height();
                            $('.chatLayer .chat_item').css('height',winH+'px');
                            $('.chatLayer .layui-m-layercont').html(chatLayerContainer.html());
                        },
                        no:function(){
                            chatLayerContainer.find('ul').html($('.chatLayer .chat_item').html());
                        }
                    });
                }   
                return false;  
            }
           
        });
        //发送聊天内容
        $('body').on('click','.send_btn',function(){
            var _this=$(this).prev();
            if(!_this.val()){
                dialog.error('不能发送空内容！');
                return false;
            }
            var to_user_id = _this.parents('.chatLayer').find('ul').data('from_id');
            var postData = {to_user_id:to_user_id,msg:_this.val()};
            var url = domain + 'index/CustomerService/sendMessage';
            $.ajax({
                url: url,
                data: postData,
                type: 'post',
                beforeSend: function(xhr){
                    $('.loading').show();
                },
                error:function(xhr){
                    $('.loading').hide();
                    dialog.error('AJAX错误');
                },
                success: function(data){
                    $('.loading').hide();
                    if(data.status==0){
                        dialog.error(data.info);
                    }else if(data.status==1){
                        var chatListTpl = $('#chatListTpl');
                        chatListTpl.find('.msg').text(_this.val());
                        $('.chatLayer .chat_item').append(chatListTpl.html());
                        _this.val('');
                    }
                }
            });
        });
        //删除
        // $('body').on('click','.detele_chat',function(){
        //     var _thisLi=$(this).parent();
        //     var postData = {};
        //     postData.from_id = _thisLi.find('ul').data('from_id');
        //     postData.messageIds = [];
        //     $.each(_thisLi.find('li'),function(){
        //         postData.messageIds.push($(this).data('id'));
        //     });
        //     var url = domain + 'index/CustomerService/setToMessageRead';
        //     $.ajax({
        //         url: url,
        //         data: postData,
        //         type: 'post',
        //         beforeSend: function(xhr){
        //             $('.loading').show();
        //         },
        //         error:function(xhr){
        //             $('.loading').hide();
        //             dialog.error('AJAX错误');
        //         },
        //         success: function(data){
        //             $('.loading').hide();
        //             if(data.status==0){
        //                 dialog.error(data.info);
        //             }else{
        //                 _thisLi.remove();
        //             }
        //         }
        //     });
        // });
    });
    //真正长按后应该执行的内容   
    // function longPress(){   
    //     timeOutEvent = 0;   
    //     //执行长按要执行的内容，如弹出菜单   
    //     alert("长按事件触发发");   
    // }
</script>
{/block}