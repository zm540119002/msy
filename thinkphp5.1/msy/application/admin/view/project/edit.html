{extend name="template/admin_pc/page_base_admin.html" /}
{block name="css-customize"}
    <link type="text/css" rel="stylesheet" href="public_admin_common_css/fenlei.css" />
    <link type="text/css" rel="stylesheet" href="public_admin_common_css/skin.css" />
{/block}
{block name="content"}
    <div class="page">
        <div class="fixed-bar">
            <div class="item-title">
                <ul class="tab-base">
                    <li><a href="{:url('manage')}" ><span>管理</span></a></li>
                    <li><a href="{:url('edit')}" class="current"><span>编辑</span></a></li>
                </ul>
            </div>
        </div>
        <div style="margin-top:15px;">
            <form id="form1">
                <table id=table18 class="add_new_merchandise" border=0 cellspacing=1 width="100%" height=57>
                    <tbody>
                    <tr>
                        <td class=dotted_bottom_gray height=40 width="11%" align=right>项目主图：</td>
                        <td class=dotted_bottom_gray width="89%" align=left><p>
                            <input type="file" class="upload" id="img">
                            <label class="uploadbtn" for="img" title="JPG,GIF,PNG"></label>
                        </p>
                            <p class="showimg" id="showimg">图片上传大小请小于50k</p>
                            {empty name="info.thumb_img"}
                                <img  class="thumb_img" src="">
                                {else /}
                                <img class="thumb_img" src="public_uploads/{$info.thumb_img}">
                            {/empty}
                        </td>
                    </tr>

                    <tr>
                        <td class=dotted_bottom_gray height=40 width="11%" align=right><font color="#FF0000">*</font>项目名称：</td>
                        <td class=dotted_bottom_gray width="40%" align=left>
                            <input style="width: 200px; " class="inputboxadmin" name="name" value="{$info.name}">
                            <input type="hidden" name="id" value="{$info.id}">
                        </td>
                    </tr>

                    <tr>
                        <td class=dotted_bottom_gray height=40 width="11%" align=right>排序：</td>
                        <td class=dotted_bottom_gray width="89%" align=left>
                            <input style="width: 100px; " class="inputboxadmin" name="sort" value="{$info.sort}">
                        </td>
                    </tr>

                    <tr>
                        <td class=dotted_bottom_gray height=40 width="11%" align=right>项目简介：</td>
                        <td class=dotted_bottom_gray width="89%" align=left>
                            <!-- 加载编辑器的容器 -->
                            <script id="intro" type="text/plain">
                                
                            </script>
                        </td>
                    </tr>
                    <tr>
                        <td class=dotted_bottom_gray height=40 width="11%" align=right>项目主图:</td>
                        <td class=dotted_bottom_gray width="89%" align=left>
                            <!-- 加载编辑器的容器 -->
                            <script id="main_img" type="text/plain">
                                
                            </script>
                            <input id="mainImg" type="hidden" value="{$info.main_img|formatImg}">
                        </td>
                    </tr>
                    <tr>
                        <td width="11%"></td>
                        <td height=60 width="50%" align=center>
                            <a href='javascript:void(0);'><input class="button_save_black_4" value="确定" type="button"></a>
                            &nbsp;&nbsp;
                            <input class="button_save_black" name="add0" value="返回" type="button">
                        </td>
                    </tr>
                    </tbody>
                </table>
            </form>
        </div>
    </div>
{/block}

{block name="script"}
<!-- 配置文件 -->
<script type="text/javascript" src="public_admin_common_js/Ueditor/ueditor.config.js"></script>
<!-- 编辑器源码文件 -->
<script type="text/javascript" src="public_admin_common_js/Ueditor/ueditor.all.js"></script>
<script type="text/javascript" charset="utf-8" src="public_admin_common_js/Ueditor/lang/zh-cn/zh-cn.js"></script>
<script src="http://cdn.bootcss.com/html5media/1.1.8/html5media.min.js"></script>
<!-- 实例化编辑器 -->
<script type="text/javascript">
    var ueIntro = UE.getEditor('intro');
    var main_img = UE.getEditor('main_img');
</script>
    <script type="text/javascript">
        $(function(){
            var intro = '{$info.intro|raw}';
            //商品简介
            if(intro){
                ueIntro.ready(function() {
                    ueIntro.setContent(intro);
                });
            }
            //项目主图
            main_img.ready(function() {
                main_img.setContent($('#mainImg').val());
            });
            // 选择图片
            $('#img').on('change',function(){
                var img = event.target.files[0];
                // 判断是否图片
                if(!img){
                    return false;
                }
                // 判断图片格式
                if(!(img.type.indexOf('image')==0 && img.type && /\.(?:jpg|png|gif|jpeg)$/.test(img.name)) ){
                    dialog.error('图片只能是jpg,jpeg,gif,png');
                    return false;
                }
                var reader = new FileReader();
                reader.readAsDataURL(img);

                reader.onload = function(e){
                    $(".thumb_img").attr("src",e.target.result);
                    //提交
                    $.post(controller + 'uploadFileToTemp',{ fileBase64: e.target.result},function(msg){
                        if(msg.status == 1){
                            $(".thumb_img").attr("src",'/uploads/' + msg.info)
                        }else{
                            parent.layer.open({
                                content:msg.info,
                                time:2
                            });
                            return false;
                        }
                    });
                }
            });


            //确定
            $('.button_save_black_4').on('click',function(){
                var postData = $('#form1').serializeObject();
                //主图
                postData.thumb_img = $('img.thumb_img').attr('src');
                //详情图
                postData.main_img = '';
                $.each($('#main_img').find('iframe').contents().find('.view img'),function(){
                    postData.main_img += $(this).attr('src') + ',';

                });
                //简介
                postData.intro = ueIntro.getContent();
                var url = module +'Project/edit';
                $.post(url,postData,function(msg){
                    dialog.msg(msg,'',function () {
                        location.href = controller + 'manage';
                    });
                });
            });

            //返回
            $('.button_save_black').click(function(){
                location.href = controller + '/manage';
            });
        });
    </script>
{/block}