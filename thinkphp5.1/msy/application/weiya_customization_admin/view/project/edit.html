{extend name="template/base_pc.html" /}
{block name="css-customize"}
    <link type="text/css" rel="stylesheet" href="public_admin_common_css/fenlei.css" />
    <link type="text/css" rel="stylesheet" href="public_admin_common_css/skin.css" />
{/block}
{block name="content"}
    <div class="page">
        <div class="fixed-bar">
            <div class="item-title">
                <ul class="tab-base">
                    <li><a href="{:url('Project/manage')}" ><span>管理</span></a></li>
                    <li><a href="{:url('Project/edit')}" class="current"><span>编辑</span></a></li>
                    <li><a href="{:url('Project/onoffLine')}"><span>上下架</span></a></li>
                </ul>
            </div>
        </div>
        <div style="margin-top:15px;">
            <form id="form1">
                <table id=table18 class="add_new_merchandise" border=0 cellspacing=1 width="100%" height=57>
                    <tbody>
                    <tr>
                        <td class=dotted_bottom_gray height=40 width="11%" align=right>项目主图：</td>
                        <td class=dotted_bottom_gray width="89%" align=left><p>
                            <input type="file" class="upload" id="img">
                            <label class="uploadbtn" for="img" title="JPG,GIF,PNG"></label>
                        </p>
                            <p class="showimg" id="showimg">图片上传大小请小于50k</p>
                            {empty name="projectInfo.main_img"}
                                <img  class="main_img" src="">
                                {else /}
                                <img class="main_img" src="uploads/{$projectInfo.main_img}">
                            {/empty}
                        </td>
                    </tr>
                    <tr>
                        <td class=dotted_bottom_gray height=40 width="11%" align=right><font color="#FF0000">*</font>所属分类：</td>
                        <td class=dotted_bottom_gray width="89%" align=left>
                            {include file="goods_category/linkage_tpl" /}
                        </td>
                    </tr>
                    <tr>
                        <td class=dotted_bottom_gray height=40 width="11%" align=right><font color="#FF0000">*</font>项目名称：</td>
                        <td class=dotted_bottom_gray width="40%" align=left>
                            <input style="width: 200px; " class="inputboxadmin" name="name" value="{$projectInfo.name}">
                            <input type="hidden" name="projectId" value="{$projectInfo.id}">
                        </td>
                    </tr>

                    <tr>
                        <td class=dotted_bottom_gray height=40 width="11%" align=right>排序：</td>
                        <td class=dotted_bottom_gray width="89%" align=left>
                            <input style="width: 100px; " class="inputboxadmin" name="sort" value="{$projectInfo.sort}">
                        </td>
                    </tr>
                    <tr>
                        <td class=dotted_bottom_gray height=40 width="11%" align=right>耗时时间(分钟)：</td>
                        <td class=dotted_bottom_gray width="89%" align=left>
                            <input style="width: 100px; " class="inputboxadmin" name="consume_time" value="{$projectInfo.consume_time}">
                        </td>
                    </tr>
                    <tr>
                        <td class=dotted_bottom_gray height=40 width="11%" align=right><font color="#FF0000">*</font>项目产品：</td>
                        <td class=dotted_bottom_gray width="89%" align=left>
                            <div class="div-goods-select-box">
                                <div id="bundling_add_goods_ajaxContent">
                                    <div class="div-goods-select">
                                        <table class="ncsc-default-table mb15">
                                            <thead>
                                            <tr>
                                                <th class="tl" colspan="2">商品名称</th>
                                                <th class="w90">原价</th>
                                                <th class="w90">数量</th>
                                                <th class="w90">操作</th>
                                            </tr>
                                            </thead>

                                        </table>

                                        <table class="search-form search_product_type">
                                            <tbody>
                                                <tr>
                                                    <td class=dotted_bottom_gray height=40 width="11%" align=right>所属分类：</td>
                                                    <td class=dotted_bottom_gray width="58%" align=left>
                                                        {include file="goods_category/linkage_tpl" /}
                                                    </td>
                                                    <th>商品名称</th>
                                                    <td class="w160">
                                                        <input class="text product_management_name" type="text" name="keyword" value="">
                                                    </td>
                                                    <td class="w70 tc">
                                                        <label class="submit-border">
                                                            <input type="button" id="searchGoods" class="submit product_search_btn" value="搜索">
                                                        </label>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <div class="content" id="goodsList"></div>
                                    </div>
                                </div>
                                <a id="bundling_add_goods_delete" class="close" href="javascript:void(0);" style="right: -10px; display: none;">X</a>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class=dotted_bottom_gray height=40 width="11%" align=right>项目简介：</td>
                        <td class=dotted_bottom_gray width="89%" align=left>
                            <!-- 加载编辑器的容器 -->
                            <script id="intro" type="text/plain">
                                {$projectInfo.intro|htmlspecialchars_decode}
                            </script>
                        </td>
                    </tr>
                    <tr>
                        <td class=dotted_bottom_gray height=40 width="11%" align=right>项目详情图:</td>
                        <td class=dotted_bottom_gray width="89%" align=left>
                            <!-- 加载编辑器的容器 -->
                            <script id="detail" type="text/plain">
                                {$projectInfo.detail_img|formatImg}
                            </script>
                        </td>
                    </tr>
                    <tr>
                        <td width="11%"></td>
                        <td height=60 width="50%" align=center>
                            <a href='javascript:void(0);'><input class="button_save_black_4" value="确定" type="button"></a>
                            &nbsp;&nbsp;
                            <input class="button_save_black" name="add0" value="返回" type="button">
                        </td>
                    </tr>
                    </tbody>
                </table>
            </form>
        </div>
    </div>
{/block}

{block name="script"}
<!-- 配置文件 -->
<script type="text/javascript" src="public_admin_common_js/Ueditor/ueditor.config.js"></script>
<!-- 编辑器源码文件 -->
<script type="text/javascript" src="public_admin_common_js/Ueditor/ueditor.all.js"></script>
<script type="text/javascript" charset="utf-8" src="public_admin_common_js/Ueditor/lang/zh-cn/zh-cn.js"></script>
<script src="http://cdn.bootcss.com/html5media/1.1.8/html5media.min.js"></script>
<!-- 实例化编辑器 -->
<script type="text/javascript">
    var ueIntro = UE.getEditor('intro');
    var ueDetail = UE.getEditor('detail');
</script>
    <script type="text/javascript" src="public_admin_common_js/categoryLinkage.js"></script>
    <script type="text/javascript">
        //商品列表
        function getPage(currentPage) {
            $("#goodsList").html($('#loading').html());
            var url = module +'Goods/getList';
            var postData = {};
            postData.category_id_1 = $('[name=goods_category_id_1]').val();
            postData.category_id_2 = $('[name=goods_category_id_2]').val();
            postData.category_id_3 = $('[name=goods_category_id_3]').val();
            postData.keyword = $('[name=keyword]').val();
            postData.p = currentPage ? currentPage : 1;
            postData.pageSize = 10;
            postData.type = 'project';
            $.get(url, postData , function(data){
                $('#goodsList').html(data);
            });
        }

        $(function(){
            //获取首页
            getPage();
            //搜索
            $('#searchGoods').click(function(){
                getPage();
            });

            //产品添加
            $('body').on('click','.add-goods',function () {
                var goodsIds = [];
                $(".checked_good").each(function(){
                    goodsIds.push($(this).data('goodsid'));
                });
                var _this = $(this);
                var _thisLi = _this.parents('li');
                var goodsId = _thisLi.data('goodsid');
                if(goodsIds.indexOf(goodsId)!= -1){
                    dialog.error('已选择此产品');
                    return false;
                }

                $.post(module+'Goods/goodsProjectList',{goodsIds:goodsIds},function(msg){
                    $('.ncsc-default-table').append(msg)
                });
            });

            //移除产品
            $('body').on('click','.goods_del',function () {
                var _this = $(this);
                var _thisTr = _this.parent().parent().parent('tr');
                _thisTr.remove();
            });

            var projectId= $('[name=projectId]').val();
            if(projectId){
                $.post(MODULE+'/Goods/goodsProjectList',{projectId:projectId},function(msg){
                    $('.ncsc-default-table').append(msg)
                });
            }

            //初始化所属分类
            var category_id_1 = '{$projectInfo.category_id_1}';
            if(category_id_1){
                $('[name=category_id_1]').val(category_id_1);
                $('[name=category_id_1]').change();
            }
            var category_id_2 = '{$projectInfo.category_id_2}';
            if(category_id_2){
                $('[name=category_id_2]').val(category_id_2);
                $('[name=category_id_2]').change();
            }
            var category_id_3 = '{$projectInfo.category_id_3}';
            if(category_id_3){
                $('[name=category_id_3]').val(category_id_3);
            }

            // 选择图片
            $('#img').on('change',function(){
                var img = event.target.files[0];
                // 判断是否图片
                if(!img){
                    return false;
                }
                // 判断图片格式
                if(!(img.type.indexOf('image')==0 && img.type && /\.(?:jpg|png|gif|jpeg)$/.test(img.name)) ){
                    dialog.error('图片只能是jpg,jpeg,gif,png');
                    return false;
                }
                var reader = new FileReader();
                reader.readAsDataURL(img);

                reader.onload = function(e){
                    $(".main_img").attr("src",e.target.result);
                    //提交
                    $.post(controller + 'uploadFileToTemp',{ fileBase64: e.target.result},function(msg){
                        if(msg.status == 1){
                            $(".main_img").attr("src",'/uploads/' + msg.info)
                        }else{
                            parent.layer.open({
                                content:msg.info,
                                time:2
                            });
                            return false;
                        }
                    });
                }
            });


            //确定
            $('.button_save_black_4').on('click',function(){
                var postData = $('#form1').serializeObject();
//                postData.goods = [];
//                var goodsEveryObj={};
//                $(".checked_good").each(function(){
//                    goodsEveryObj={
//                        goodsId:$(this).data('goodsid'),
//                        goodsNum:$(this).find('.goodsNum').val()
//                    };
//                    postData.goods.push(goodsEveryObj);
//                });
                //主图
                postData.main_img = $('img.main_img').attr('src');
                //详情图
                postData.detail_img = '';
                $.each($('#detail').find('iframe').contents().find('.view img'),function(){
                    postData.detail_img += $(this).attr('src') + ',';

                });
                //简介
                postData.intro = ueIntro.getContent();
                var url = module +'Project/edit';
                $.post(url,postData,function(msg){

//                    dialog.msg(msg);
                });
            });

            //返回
            $('.button_save_black').click(function(){
                location.href = controller + '/manage';
            });
        });
    </script>
{/block}