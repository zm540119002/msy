{extend name="template/base.html" /}
{block name="css-customize"}

{/block}
{block name="content"}
<!--新建标签-->
<section id="addTagForm" style="display:none;">
	<form>
		<input type="text" placeholder="填写排序号" class="layer-tag-num" value=""/>
		<input type="text" placeholder="填写标签名称" class="layer-tag-name" value=""/>
	</form>
	<div class="error_tipc"></div>
</section>

<article class="f24">
	<section class="">
		<nav class="columns_flex channel_nav top-nav-bar ">
			<a class="personal_center">我的</a>
			<a href="javascript:void(0);" class="current store-type" data-type="1">
				采购
			</a>
			<a href="javascript:void(0);" class="store-type" data-type="2">
				分成
			</a>
			<a href="javascript:void(0);" class="store-type" data-type="3">
				零售
			</a>
			<a class="home">首页</a>
		</nav>
	</section>
	<section class="specific_type bottomLine">
		<div class="columns_flex f20">
			<a class="">店铺首页</a>
			<a>限时抢购</a>
			<a>新品尝鲜</a>
		</div>
	</section>
	<section class="content-marginLeft separation-line">
		<div>
			企业名称:
			<span>达安有限公司</span>
		</div>
		<p>采购店铺提供产品给美容店家进行B2F联合采购</p>
		<a href="javascript:void(0);" class="stroe-preview">采购店铺预览></a>
		<a href="javascript:void(0);" class="addSalesActivity text-color-gr right-arrow">新建促销活动</a>
	</section>
	<section class="separation-line sales-promotion-content">
		<div class="category-wrapper">
			<div class="category-left-menu sort-left-menu">
                <ul class="category-tab">
                    <li class="current">
                        <a href="javascript:void(0);" data-activity-status="1" class="activity-status">未结束</a>
                    </li>
                    <li>
                        <a href="javascript:void(0);" data-activity-status="0" class="activity-status">已结束</a>
                    </li>
                </ul>
            </div>
			<input type="hidden" value="1" class="isClick">
			<div class="promotion-item" >
				<p class="content-label">促销活动的修改、删除和排序</p>
				<div class="classify-label-content " id="list">

				</div>
			</div>
		</div>
	</section>
	<section class="separation-line sales-promotion-content">
		
	</section>
</article>
{/block}
{block name="common"}
{include file="template/loading.html" /}
{/block}
{block name="footer"}{/block}
{block name="script"}
<!--<script type="text/javascript" src="factory_js/promotion.js"></script>-->
<script type="text/javascript">
	//店铺类型，如果没有，就默认为采购类型
	var storeType = "{$storeType}";
	$(function () {
		//默认选中店铺类型
		$(".store-type").each(function(i){
			if($(this).data('type')==storeType){
				$(this).addClass('current').siblings().removeClass('current');
				return false;
			}
		});
		//初始化
		var activityStatus=$('.category-tab li.current a').data('activity-status');
		var config = {
			storeType:storeType,
			activityStatus:activityStatus,//未结束
		};
		currentPage=1;
		requestEnd=false;
		var url = module+'promotion/getList';
		getPage(url,config);

		//选择店铺类型
		$('body').on('click','.store-type',function () {
			var _this=$(this);
			_this.addClass('current').siblings().removeClass('current');
			var storeType=_this.data('type');
			var config = {
				storeType:storeType,
				activityStatus:1,//未结束
			};
			currentPage=1;
			requestEnd=false;
			var url = module+'promotion/getList';
			getPage(url,config);
		});

		//点击新建促销活动
		$('body').on('click','.addSalesActivity',function () {
			var storeType=$('.store-type.current').data('type');
			location.href = module + 'promotion/edit/storeType/'+storeType;
		});

		//促销活动状态
		$('body').on('click','.category-tab li',function () {
			var index=$(this).index();
			$(this).addClass('current').siblings().removeClass('current');
			var activityStatus = $(this).find('a').data('activity-status');
			var storeType=$('.store-type.current').data('type');
				var config = {
					storeType:storeType,
					activityStatus:activityStatus,//未结束
				};
				currentPage=1;
				requestEnd=false;
				var url = module+'promotion/getList';
				getPage(url,config);
			
//			$('.promotion-item').hide().eq(index).show();
		})
	});

	//获取列表
	var currentPage = 1;//记录当前页
	var requestEnd = false;//请求结束标记
	function getPage(url,config) {
		var postData = $.extend({},config);
		postData.page = currentPage ? currentPage : 1;
		postData.pageSize = postData.pageSize?postData.pageSize:7;
		//请求结束标志
		if(requestEnd){
			dialog.error('没有更多啦');
			loadTrigger = true;
			return false;
		}
		$.ajax({
			url: url,
			data: postData,
			type: 'get',
			dataType:'json',
			beforeSend: function(){
				$('.loading').show();
			},
			error:function (xhr) {
				$('.loading').hide();
				dialog.error('AJAX错误');
			},
			success: function(data){
				$('.loading').hide();
				if(currentPage == 1){
					if(config.activityStatus == 1){
						$('.promotion-item .content-label').text('促销活动的修改、删除和排序');
					}
					if(config.activityStatus==0){
						$('.promotion-item .content-label').text('已结束的促销活动');
					}
					$('#list .tag-item').remove();
					$('#list').append(data);
				}else{
					$('#list .tag-item:last').after(data);
				}
				if($($.parseHTML(data)).length<postData.pageSize){
					requestEnd = true;
				}
				currentPage ++;
				loadTrigger = true;
			}
		});
	}

	//上拉加载更多
	var loadTrigger = false;//加载触发器
	$('.classify-label-content ').on('scroll',function(){
		var listHeight=document.getElementById('list').scrollHeight;
		console.log(1);
		if(loadTrigger && $('.classify-label-content ').scrollTop()+$('.classify-label-content ').height()>=listHeight){
			
			loadTrigger = false;
			var storeType=$('.store-type.current').data('type');
			console.log(storeType);
			var activityStatus=$('.category-tab li.current a').data('activity-status');
			var config = {
				storeType:storeType,
				activityStatus:activityStatus,//活动状态
			};
			var url = module+'promotion/getList';
			getPage(url,config)
		}
	});
</script>
{/block}