{extend name="template/base.html" /}
{block name="css-customize"}
<link rel="stylesheet" href="factory_css/main.css">
{/block}
{block name="content"}
<!--新建标签-->
<section id="addTagForm" style="display:none;">
	<form>
		<input type="text" placeholder="填写排序号" class="layer-tag-num" value=""/>
		<input type="text" placeholder="填写标签名称" class="layer-tag-name" value=""/>
	</form>
	<div class="error_tipc"></div>
</section>

<article class="f24">
	<section class="top_nav_fixed">
		<div class="top_bar columns_flex l-r-sides">
			<div class="">
				<a class="home">首页</a>
			</div>
			<div class="">
				<img src="http://msy.new.com/static/common/img/default/no_pic_40.jpg" alt="">
				<span>爱国宾</span>
			</div>
			<div class="">
				<a class="switch-account">切换我的店铺</a>
			</div>
		</div>
	</section>
	<section class="columns_flex l-r-sides">
		<div>
			<img class="left" src="http://msy.new.com/static/common/img/default/no_pic_40.jpg" alt="">
			<div>
				<p><span>某某</span>官方旗舰店</p>
				<p>B2B采购商城 <span>供应商自营</span></p>
			</div>
		</div>
		<div>
			<a href="" class="personal_center">我的</a>
			<a href="" class="my-store">我的店铺</a>
		</div>
	</section>
	<section class="bottomLine">
		<nav class="columns_flex channel_nav manufacturer_nav">
			<a href="">
				店铺提醒
			</a>
			<a href="">
				店铺管理
			</a>
			<a href=""  class="current">
				营销推广
			</a>
			<a href="">
				官方活动
			</a>
		</nav>
	</section>
	<section class="specific_type store-manage-type bottomLine">
		<div class="columns_flex f20">
			<a  href="javascript:void (0)" class="column_type current">场景</a>
			<a >云推客</a>
			<a href="javascript:void (0)">线上</a>
			<a href="javascript:void (0)">线下</a>
			<a href="javascript:void (0)">视频</a>
			<a href="javascript:void (0)">直播</a>
		</div>
	</section>
	<section class="content-marginLeft separation-line">
		<div>
			企业名称:
			<span>达安有限公司</span>
		</div>
		<p>采购店铺提供产品给美容店家进行B2F联合采购</p>
		<a href="javascript:void(0);" class="stroe-preview">采购店铺预览></a>
		<a href="javascript:void(0);" class="addSalesActivity text-color-gr right-arrow">新建促销活动</a>
	</section>
	<section class="separation-line sales-promotion-content">
		<div class="category-wrapper">
			<div class="category-left-menu sort-left-menu">
                <ul class="category-tab">
                    <li class="current">
                        <a href="javascript:void(0);" data-activity-status="1" class="activity-status">未结束</a>
                    </li>
                    <li>
                        <a href="javascript:void(0);" data-activity-status="0" class="activity-status">已结束</a>
                    </li>
                </ul>
            </div>
			<input type="hidden" value="1" class="isClick">
			<div class="promotion-item" >
				<p class="content-label">促销活动的修改、删除和排序</p>
				<div class="classify-label-content " id="list">

				</div>
			</div>
		</div>
	</section>
	<section class="separation-line sales-promotion-content">
		
	</section>
</article>
{/block}
{block name="common"}
{include file="template/loading.html" /}
{/block}
{block name="footer"}{/block}
{block name="script"}
<!--<script type="text/javascript" src="factory_js/promotion.js"></script>-->
<script type="text/javascript">
	$(function () {
		//初始化
		var activityStatus=$('.category-tab li.current a').data('activity-status');
		var config = {
			activityStatus:activityStatus,//未结束
		};
		currentPage=1;
		requestEnd=false;
		var url = module+'promotion/getList';
		getPage(url,config);

		//点击新建促销活动
		$('body').on('click','.addSalesActivity',function () {
			location.href = module + 'promotion/edit'
		});

		//根据促销活动状态获取活动列表
		$('body').on('click','.category-tab li',function () {
			$(this).addClass('current').siblings().removeClass('current');
			var activityStatus = $(this).find('a').data('activity-status');
				var config = {
					activityStatus:activityStatus,//未结束
				};
				currentPage=1;
				requestEnd=false;
				var url = module+'promotion/getList';
				getPage(url,config);
		})

		//删除促销活动
		$('body').on('click','.del-icons',function () {
			var _this = $(this);
			var postData = {};
			postData.id = _this.parent().data('id');
			$.post(module+'Promotion/del',postData,function (msg) {
				if(msg.status == 0){
					dialog.error(msg.info);
					return false;
				}
				_this.parents('.tag-item').remove();
				dialog.success(msg.info);
			})
		})
	});

	//获取列表
	var currentPage = 1;//记录当前页
	var requestEnd = false;//请求结束标记
	function getPage(url,config) {
		var postData = $.extend({},config);
		postData.page = currentPage ? currentPage : 1;
		postData.pageSize = postData.pageSize?postData.pageSize:7;
		//请求结束标志
		if(requestEnd){
			dialog.error('没有更多啦');
			loadTrigger = true;
			return false;
		}
		$.ajax({
			url: url,
			data: postData,
			type: 'get',
			dataType:'json',
			beforeSend: function(){
				$('.loading').show();
			},
			error:function (xhr) {
				$('.loading').hide();
				dialog.error('AJAX错误');
			},
			success: function(data){
				$('.loading').hide();
				if(currentPage == 1){
					if(config.activityStatus == 1){
						$('.promotion-item .content-label').text('促销活动的修改、删除和排序');
					}
					if(config.activityStatus==0){
						$('.promotion-item .content-label').text('已结束的促销活动');
					}
					$('#list .tag-item').remove();
					$('#list').append(data);
				}else{
					$('#list .tag-item:last').after(data);
				}
				if($($.parseHTML(data)).length<postData.pageSize){
					requestEnd = true;
				}
				currentPage ++;
				loadTrigger = true;
			}
		});
	}

	//上拉加载更多
	var loadTrigger = false;//加载触发器
	$('.classify-label-content ').on('scroll',function(){
		var listHeight=document.getElementById('list').scrollHeight;
		if(loadTrigger && $('.classify-label-content ').scrollTop()+$('.classify-label-content ').height()>=listHeight){
			loadTrigger = false;
			var activityStatus=$('.category-tab li.current a').data('activity-status');
			var config = {
				activityStatus:activityStatus,//活动状态
			};
			var url = module+'promotion/getList';
			getPage(url,config)
		}
	});
</script>
{/block}