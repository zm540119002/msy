{extend name="../../api/public/template/base.html" /}
{block name="css-customize"}
<link rel="stylesheet" href="public_css/project_public.css">
{/block}
<!-- 项目公共模块-->
{block name="common-base"}{/block}
{block name="pre-script"}
<script type="text/javascript">
    //用于后面判断是否登录
    var user_id = "{$user.id}";
    var total_num = "{$total_num}";
</script>
{/block}
<!-- 自定义js -->
{block name="suffix-script"}
<script type="text/javascript" src="api_common_js/dialog.js"></script>
<script type="text/javascript" src="api_common_js/paging.js"></script>
<script type="text/javascript">
    //异步验证判断
    function async_verify_judge(param){
        if(param.data.status==0){
            if(param.data.data.code == '1001'){
                //未登录
                loginDialogTrigger();
                return false;
            }else if(param.data.data.code=='1002'){
                return false;
            }
            dialog.error(param.data.info);
        }else if(param.data.status==1){
            if(param.data.data.code == '1001'){
                //已登录
                param.func();
                return false;
            }else if(param.data.data.code=='1002'){
                return false;
            }else if(param.data.data.code=='1003'){
                location.href=param.jump_url;
                return false;
            }
            dialog.success(param.data.info);
        }
    }
    //编辑cookie里的购物车商品列表
    function editLocalStorageCartList(goodsList){
        var cartList = localStorage.cartList?JSON.stringify(localStorage.cartList):{};
        $.each(goodsList,function(i,o){
            console.log(i);
            console.log(o);
        });
    }
    /**没有登录购物车 操作
     * @param postData
     */
    cart = {
        //向购物车中添加商品
        addCart: function (addGoodsList) {
            //获取存储购物车商品信息
            var cartListOld = localStorage.cartList;
            if (cartListOld == null || cartListOld == ""){
                //第一次加入商品
                var cartList = JSON.stringify(addGoodsList);
                localStorage.setItem('cartList',cartList);
                var goodsList = addGoodsList.goodsList;
            }else {
                var jsonstr = JSON.parse(cartListOld);
                var goodsList = jsonstr.goodsList;
                var addGoodsList = addGoodsList.goodsList;
                //查找购物车中是否有该商品
                $.each(addGoodsList,function(i,addGoods){
                    var find = false;
                    $.each(goodsList,function(j,goods){
                        if(addGoods.goods_id == goods.goods_id && addGoods.buy_type == goods.buy_type){
                            //找到修改数量
                            find = true;
                            goodsList[j].num = parseInt(addGoods.num) + parseInt(goods.num);
                            return;
                        }
                    });
                    if(!find){
                        //没有该商品就直接加进去
                        goodsList.unshift({
                            "goods_id": addGoods.goods_id,
                            "num": addGoods.num,
                            "buy_type": addGoods.buy_type
                        });
                    }
                });
                var cartList = {
                    goodsList:goodsList
                };
                //保存购物车
                localStorage.setItem('cartList',JSON.stringify(cartList));
            }
            //计算总数
            var total_num = 0;
            $.each(goodsList,function(i,goods){
                total_num += parseInt(goods['num']);
            });
            dialog.success('成功');
            $('footer').find('.cart_num').addClass('cur');
            $('footer').find('.add_num').text(total_num).addClass('current');
        },
        //修改商品数量
        editCartNum:function (goods) {
            //获取存储购物车商品信息
            var cartListOld = localStorage.cartList;
            var jsonstr = JSON.parse(cartListOld);
            var goodsList = jsonstr.goodsList;
            $.each(goodsList,function(j,oldgoods){
                if(goods.goods_id == oldgoods.goods_id){
                    //找到修改数量
                    goodsList[j].num = parseInt(goods.num);
                    return;
                }
            });
            var cartList = {
                goodsList:goodsList
            };
            //保存购物车
            localStorage.setItem('cartList',JSON.stringify(cartList));
        },
        //删除商品
        delCart:function (goods) {
            var cartListOld = localStorage.cartList;//获取存储购物车商品信息
            var jsonstr = JSON.parse(cartListOld);
            var goodsList = jsonstr.goodsList;
            $.each(goods.goods_ids,function(i,goods_id){
                $.each(goodsList,function(j,oldgoods){
                    if(goods_id == oldgoods.goods_id){
                        goodsList = goodsList.filter(function (element, index, self) {
                            return index<j||index>j
                        });
                    }
                });
            });
            var cartList = {
                goodsList:goodsList
            };
            //保存购物车
            localStorage.setItem('cartList',JSON.stringify(cartList));
            //删除对应的商品列
            dialog.success('成功');
            $.each(goods.goods_ids,function(i,goods_id){
                $.each($('.cart_goods_list li'),function(j,oldgoods){
                    var id = $(this).data('id');
                    if(goods_id == id){
                        $(this).remove();
                    }
                });
            });
        },
        //统计购物车的数量
        getGoodsTotal:function () {
            var cartListOld = localStorage.cartList;//获取存储购物车商品信息
            var total_num = '';
            if(cartListOld){
                var jsonstr = JSON.parse(cartListOld);
                var goodsList = jsonstr.goodsList;
                //计算总数
                $.each(goodsList,function(i,goods){
                    total_num += parseInt(goods['num']);
                });
            }
            return total_num;
        }
    };
</script>
{/block}