{extend name="template/admin_pc/base.html" /}

{block name="css-customize"}
<link type="text/css" rel="stylesheet" href="index_admin_css/fenlei.css" />
<link type="text/css" rel="stylesheet" href="index_admin_css/skin.css" />
{/block}

{block name="content"}
<div class="page-container">
    <form class="form form-horizontal" id="form1">
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>所属分类：</label>
            <div class="formControls col-xs-8 col-sm-9">
                {include file="goods_category/linkage_tpl" /}
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2">类别：</label>
            <div class="formControls col-xs-8 col-sm-9">
                {volist name="$Think.config.custom.belong_to" id ='vo' key="k"}
                {if ($info.belong_to[$k-1])}
                <input type="checkbox" name="belong_to" value="" checked="checked">{$vo}
                {else /}
                <input type="checkbox" name="belong_to" value="">{$vo}
                {/if}
                {/volist}
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>商品名称：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" placeholder="" name="name" value="{$info.name}">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>文案标题：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" placeholder="" name="headline" value="{$info.headline}">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>零售价：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" placeholder="0.00" name="retail_price" value="{$info.retail_price}">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>出厂价：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" placeholder="0.00" name="factory_price" value="{$info.factory_price}">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>代理特价：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" placeholder="0.00" name="agent_special_price" value="{$info.agent_special_price}">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>代理价：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" placeholder="0.00" name="agent_price" value="{$info.agent_price}">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>加盟特价：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" placeholder="0.00" name="franchise_special_price" value="{$info.franchise_special_price}">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>加盟价：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" placeholder="0.00" name="franchise_price" value="{$info.franchise_price}">
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>商品规格：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <textarea name="specification" cols="" rows="" class="textarea"  placeholder="写点什么..." datatype="*10-100" dragonfly="true" nullmsg="备注不能为空！">{$info.specification}</textarea>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>分享标题：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <textarea name="share_title" cols="" rows="" class="textarea"  placeholder="写点什么..." datatype="*10-100" dragonfly="true" nullmsg="备注不能为空！">{$info.share_title}</textarea>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>分享描述：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <textarea name="share_desc" cols="" rows="" class="textarea"  placeholder="写点什么..." datatype="*10-100" dragonfly="true" nullmsg="备注不能为空！">{$info.share_desc}</textarea>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2">商品采购规格描述：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" placeholder="例：10盒/箱 按箱采购 100个字符以内" name="purchase_specification_description" value="{$info.purchase_specification_description}">
            </div>
        </div>
<!--    不需要
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2">起订数量：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" placeholder="" name="minimum_order_quantity" value="{$info.minimum_order_quantity|default=1}">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2">起订递增数量：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" placeholder="" name="increase_quantity" value="{$info.increase_quantity|default=1}">
            </div>
        </div>-->

        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2">采购单位：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <select name="purchase_unit">
                    <option value="">请选择单位</option>
                    {volist name="unitList" id="unit"  key="k"}
                    <option value="{$k}">{$unit}</option>
                    {/volist}
                </select>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2">排序：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" placeholder="" name="sort" value="{$info.sort|default=$sort_num}">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2">标签：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" placeholder="多个标签请用逗号分隔，例如：正品保障,纳晶水光" name="tag" value="{$info.tag}">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>商品简介：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <textarea name="intro" cols="" rows="" class="textarea"  placeholder="说点什么..." datatype="*10-100" dragonfly="true" nullmsg="备注不能为空！">{$info.intro}</textarea>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>商品参数：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <script id="param" type="text/plain">

                </script>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>商品主图：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <script id="main_img" type="text/plain"></script>
                <input id="mainImg" type="hidden"  value="{$info.main_img|formatImg}">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-2">商品详情图：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <script id="detail_img" type="text/plain"></script>
                <input id="detailImg" type="hidden" value="{$info.detail_img|formatImg}">
            </div>
        </div>
        <div class="row cl">
            <div class="col-xs-8 col-sm-9 col-xs-offset-4 col-sm-offset-2">
                <input type="hidden" name='id' value="{$info.id}">
                <button class="btn btn-primary radius button_save_black_4" type="button"><i class="Hui-iconfont">&#xe632;</i> 保存</button>
                <button onClick="layer_close();" class="btn btn-default radius" type="button">&nbsp;&nbsp;取消&nbsp;&nbsp;</button>
                <span class="c-red">*</span>(图片只显示缩略图，不影响原效果)
            </div>
        </div>
    </form>
</div>

{/block}
{block name="script"}
<script type="text/javascript" src="hui_lib/Ueditor/ueditor.config.js"></script>
<!-- 编辑器源码文件 -->
<script type="text/javascript" src="hui_lib/Ueditor/ueditor.all.js"></script>
<script type="text/javascript" charset="utf-8" src="hui_lib/Ueditor/lang/zh-cn/zh-cn.js"></script>
<script src="https://cdn.bootcss.com/html5media/1.1.8/html5media.min.js"></script>

<!-- 实例化编辑器 -->
<script type="text/javascript">
    var ueParam = UE.getEditor('param', {
        toolbars: [
            [  'fullscreen', 'source', '|', 'undo', 'redo', '|',
                'bold', 'italic', 'underline', 'fontborder', 'strikethrough', 'superscript', 'subscript', 'removeformat', 'formatmatch', 'autotypeset', 'blockquote', 'pasteplain', '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|',
                'rowspacingtop', 'rowspacingbottom', 'lineheight', '|',
                'customstyle', 'paragraph', 'fontfamily', 'fontsize', '|',
                'directionalityltr', 'directionalityrtl', 'indent', '|',
                'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', '|', 'touppercase', 'tolowercase', '|',
                'anchor', '|', 'emotion', 'scrawl',   'webapp', 'pagebreak', 'template', 'background', '|',
                'horizontal', 'date', 'time', 'spechars', 'snapscreen', 'wordimage', '|',
                'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', 'charts', '|',
                'print', 'preview', 'searchreplace', 'drafts', 'help']
        ],
        autoHeightEnabled: true,
        autoFloatEnabled: true,
        initialFrameWidth: '100%'
    });

    var config_img = {
        toolbars: [
            ['imagenone', 'imageleft', 'imageright', 'imagecenter', 'simpleupload', 'insertimage']
        ],
        autoHeightEnabled: true,
        autoFloatEnabled: true,
        initialFrameWidth: '100%'
    };

    var ueNotices= UE.getEditor('main_img',config_img);
    var ueDetail = UE.getEditor('detail_img',config_img);

</script>

<script type="text/javascript" src="api_common_js/admin/categoryLinkage.js"></script>
<script type="text/javascript">
    $(function(){
        var parameters = '{$info.parameters|raw}';
        //商品参数
        if(parameters){
            ueParam.ready(function() {
                ueParam.setContent(parameters);
            });
        }

        //商品主图
        ueNotices.ready(function() {
            ueNotices.setContent($('#mainImg').val());
        });
        //商品详情图
        ueDetail.ready(function() {
            ueDetail.setContent($('#detailImg').val());
        });

        //初始化所属分类
        var category_id_1 = '{$info.category_id_1}';
        if(category_id_1){
            $('[name=category_id_1]').val(category_id_1);
            $('[name=category_id_1]').change();
        }
        var category_id_2 = '{$info.category_id_2}';
        if(category_id_2){
            $('[name=category_id_2]').val(category_id_2);
            $('[name=category_id_2]').change();
        }

        var purchase_unit = '{$info.purchase_unit}';
        if(purchase_unit){
            $('[name=purchase_unit]').val(purchase_unit);
        }
        // 选择单视频
        $('body').on('change','.uploadSingleVideo',function () {
            _this = $(this);
            uploadsSingleVideoFlag = false;
            var video = event.target.files[0];
            var obj=$(this).parent();
            // 判断是否视频
            if(!video){
                return false;
            }
            // 判断视频格式
            var imgRegExp=/\.(?:mp4|rmvb|avi|ts)$/;
            if(!(video.type.indexOf('video')==0 && video.type && imgRegExp.test(video.name)) ){
                dialog.error('请上传：mp4、rmvb、avi、ts格式图片');
                return false;
            }
            if( (video.size/1024/1024)>10){
                dialog.error('视频大小不能超过10M !');
                return false;
            }


            var reader = new FileReader();
            reader.readAsDataURL(video);
            reader.onload = function(e){
                var postData = {fileBase64: e.target.result};
                var videoUrl=e.target.result;
                $(obj).find('video').attr('src',videoUrl);
                //提交
                var type = _this.data('type');
                if(type == 'notupload'){
                    $(obj).find('.img').val(videoUrl);
                    return false;
                }
                $.post(controller+"uploadFileToTemp",postData,function(msg){
                    if(msg.status == 1){
                        uploadsSingleVideoFlag = true;
                        $(obj).find('.img').val(msg.info);
                    }else{
                        dialog.error(msg.info)
                    }
                })

            }
        });
        //确定
        $('.button_save_black_4').on('click',function(){
            var postData = $('#form1').serializeObject();

            //缩略图
//                postData.thumb_img = $('img.thumb_img').attr('src');
            //主图
            postData.main_img = '';
            $.each($('#main_img').find('iframe').contents().find('.view img'),function(){
                postData.main_img += $(this).attr('src') + ',';

            });
            //详情图
            postData.detail_img = '';
            $.each($('#detail_img').find('iframe').contents().find('.view img'),function () {
                postData.detail_img += $(this).attr('src') + ',';
            });
            //简介
            postData.parameters = ueParam.getContent();


            postData.franchise_price = postData.franchise_price.replace(/^\s*|\s*$/g,"");
//                console.log(postData.belong_to);
//                console.log(sum(postData.belong_to));
//                console.log(sum(postData.belong_to));return false;
            var content='';
            if(!postData.name){
                content='请填写商品名称';
            }else if(!postData.headline){
                content='请填写商品标题文案';
            }
            else if(!postData.franchise_price){
                content='请填写批量价格';
            }else if(!isMoney(postData.franchise_price)){
                content='价格格式有误';
            }
            else if(!postData.specification){
                content='请填写商品规格';
            }else if(!postData.main_img){
                content='请上传主图';
            }else if(!postData.detail_img){
                content='请上传商品详情图';
            }
            if(content){
                dialog.error(content);
                return false;
            }

            var _this = $(this);
            _this.addClass("nodisabled");//防止重复提交
            $.post(action,postData,function(data){
                _this.removeClass("nodisabled");//防止重复提交
                dialog.msg(data,'',function () {

                    // 提交后关闭 保持要搜索的参数
                    window.parent.search();
                    var index = parent.layer.getFrameIndex(window.name);   //先得到当前iframe层的索引

                    parent.layer.close(index);
                });
            });
        });
    });
</script>

{/block}